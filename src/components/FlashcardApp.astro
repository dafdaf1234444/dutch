---
// FlashcardApp – Dutch vocabulary flashcard practice.
// Two-way cards (Dutch→English / English→Dutch / Mixed), single-button
// flow, keyboard shortcuts, reshuffle. Standalone audio via Web Speech API.
---

<flashcard-app id="flashcard-app"></flashcard-app>

<script>
import { speakDutch } from "../scripts/dutch-speech";
import { DECKS, type Word } from "../data/flashcard-decks";

/* Standalone audio handler for flashcard audio buttons */
document.addEventListener("click", (e) => {
  const btn = (e.target as Element).closest?.(".dutch-audio-btn") as HTMLButtonElement | null;
  if (!btn) return;
  const text = btn.dataset.text;
  if (!text) return;
  speakDutch(text, btn);
});
const TOPICS = DECKS;
const FC_STORAGE_KEY = "dutch-fc-progress";

type Direction = "nl-en" | "en-nl" | "mixed" | "listen" | "dictation";

interface CardProgress {
  ease: number;      // 0=new, 1=again, 2=hard, 3=easy
  lastSeen: number;  // timestamp
  reviews: number;
  favorite: boolean;
}

interface FCStorage {
  cards: Record<string, CardProgress>;
  stats: { totalReviews: number; lastDate: string; streak: number };
}

class FlashcardApp extends HTMLElement {
  selectedTopics: Set<number> = new Set();
  cards: Word[] = [];
  order: number[] = [];
  current = 0;
  flipped = false;
  direction: Direction = "mixed";
  /* per-card: true = show Dutch first, false = show English first */
  showDutchFirst: boolean[] = [];
  /* dictation scoring */
  correctCount = 0;
  totalAnswered = 0;
  /* progress & favorites */
  showFavoritesOnly = false;
  private storage: FCStorage = { cards: {}, stats: { totalReviews: 0, lastDate: "", streak: 0 } };

  static SVG = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
  static HEART = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;

  private _keyHandler: ((e: KeyboardEvent) => void) | null = null;

  connectedCallback() {
    this.loadStorage();
    this.renderTopicGrid();
  }

  /* ---- Storage helpers ---- */

  private loadStorage(): void {
    try {
      const raw = localStorage.getItem(FC_STORAGE_KEY);
      if (raw) this.storage = JSON.parse(raw);
    } catch { /* localStorage unavailable */ }
  }

  private saveStorage(): void {
    try {
      localStorage.setItem(FC_STORAGE_KEY, JSON.stringify(this.storage));
    } catch { /* localStorage unavailable */ }
  }

  private cardKey(card: Word): string {
    return card.dutch.toLowerCase();
  }

  private getProgress(card: Word): CardProgress {
    return this.storage.cards[this.cardKey(card)] ?? { ease: 0, lastSeen: 0, reviews: 0, favorite: false };
  }

  private rateCard(card: Word, ease: number): void {
    const key = this.cardKey(card);
    const prev = this.storage.cards[key] ?? { ease: 0, lastSeen: 0, reviews: 0, favorite: false };
    this.storage.cards[key] = { ...prev, ease, lastSeen: Date.now(), reviews: prev.reviews + 1 };
    this.storage.stats.totalReviews++;
    const today = new Date().toISOString().slice(0, 10);
    const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
    if (this.storage.stats.lastDate !== today) {
      this.storage.stats.streak = this.storage.stats.lastDate === yesterday ? this.storage.stats.streak + 1 : 1;
      this.storage.stats.lastDate = today;
    }
    this.saveStorage();
  }

  private toggleFavorite(card: Word): void {
    const key = this.cardKey(card);
    const prev = this.storage.cards[key] ?? { ease: 0, lastSeen: 0, reviews: 0, favorite: false };
    this.storage.cards[key] = { ...prev, favorite: !prev.favorite };
    this.saveStorage();
  }

  private isFavorite(card: Word): boolean {
    return this.getProgress(card).favorite;
  }

  private getFavoritesCount(): number {
    return Object.values(this.storage.cards).filter(c => c.favorite).length;
  }

  shuffle<T>(arr: T[]): T[] {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  esc(s: string): string {
    return s.replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  }

  bindKeys() {
    this.unbindKeys();
    this._keyHandler = (e: KeyboardEvent) => {
      if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) return;
      if (e.key === " " || e.key === "Enter") {
        e.preventDefault();
        this.advance();
      } else if (e.key === "ArrowRight") {
        e.preventDefault();
        if (this.flipped) { this.current++; this.flipped = false; this.renderCard(); }
      } else if (e.key === "ArrowLeft") {
        e.preventDefault();
        if (this.current > 0) { this.current--; this.flipped = false; this.renderCard(); }
      }
    };
    document.addEventListener("keydown", this._keyHandler);
  }

  unbindKeys() {
    if (this._keyHandler) {
      document.removeEventListener("keydown", this._keyHandler);
      this._keyHandler = null;
    }
  }

  advance() {
    if (this.direction === "dictation") {
      if (!this.flipped) {
        this.submitDictation();
      } else {
        this.current++;
        this.flipped = false;
        this.renderCard();
      }
      return;
    }
    if (!this.flipped) {
      this.flipped = true;
      /* Auto-play Dutch audio when revealing Dutch side */
      const card = this.cards[this.order[this.current]];
      if (!this.showDutchFirst[this.current]) {
        speakDutch(card.dutch);
      }
      this.renderCard();
    } else {
      this.current++;
      this.flipped = false;
      this.renderCard();
    }
  }

  /* ---- topic selection screen ---- */

  renderTopicGrid() {
    this.unbindKeys();
    const totalSelected = [...this.selectedTopics].reduce(
      (sum, i) => sum + TOPICS[i].words.length, 0
    );

    const dirLabels: Record<Direction, string> = {
      "nl-en": "Dutch → English",
      "en-nl": "English → Dutch",
      "mixed": "Mixed (both ways)",
      "listen": "Listen",
      "dictation": "Dictation",
    };

    const { totalReviews, streak } = this.storage.stats;
    const favCount = this.getFavoritesCount();
    const statsLine = totalReviews > 0
      ? `${totalReviews} reviews${streak > 1 ? ` · ${streak}-day streak` : ""}`
      : "";

    this.innerHTML = `
      <div class="fc-container">
        <h2 class="fc-heading">Choose Topics</h2>
        <p class="fc-subheading">Select topics, pick a direction, then start.${statsLine ? `<br><span class="fc-stats-line">${statsLine}</span>` : ""}</p>

        <div class="fc-topic-grid">
          ${TOPICS.map((t, i) => `
            <button class="fc-topic-card ${this.selectedTopics.has(i) ? "fc-topic-selected" : ""}"
                    data-index="${i}" type="button">
              <span class="fc-topic-check">${this.selectedTopics.has(i) ? "&#10003;" : ""}</span>
              <span class="fc-topic-name">${t.name}</span>
              <span class="fc-topic-count">${t.words.length} words</span>
            </button>
          `).join("")}
        </div>

        <div class="fc-direction">
          ${(["nl-en", "en-nl", "mixed", "listen", "dictation"] as Direction[]).map(d => `
            <button class="fc-dir-btn ${this.direction === d ? "fc-dir-active" : ""}"
                    data-dir="${d}" type="button">${dirLabels[d]}</button>
          `).join("")}
        </div>

        <div class="fc-actions">
          <button class="fc-btn fc-btn-secondary" id="fc-select-all" type="button">
            ${this.selectedTopics.size === TOPICS.length ? "Deselect All" : "Select All"}
          </button>
          ${favCount > 0 ? `<button class="fc-btn fc-btn-secondary ${this.showFavoritesOnly ? "fc-fav-active" : ""}" id="fc-fav-filter" type="button">&#9829; Favorites (${favCount})</button>` : ""}
          <button class="fc-btn fc-btn-primary" id="fc-start" type="button"
                  ${totalSelected === 0 ? "disabled" : ""}>
            Start (${totalSelected} cards)
          </button>
        </div>
      </div>`;

    this.querySelectorAll<HTMLButtonElement>(".fc-topic-card").forEach((btn) => {
      btn.addEventListener("click", () => {
        const idx = Number(btn.dataset.index);
        this.selectedTopics.has(idx) ? this.selectedTopics.delete(idx) : this.selectedTopics.add(idx);
        this.renderTopicGrid();
      });
    });

    this.querySelectorAll<HTMLButtonElement>(".fc-dir-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        this.direction = btn.dataset.dir as Direction;
        this.renderTopicGrid();
      });
    });

    this.querySelector("#fc-select-all")!.addEventListener("click", () => {
      if (this.selectedTopics.size === TOPICS.length) this.selectedTopics.clear();
      else TOPICS.forEach((_, i) => this.selectedTopics.add(i));
      this.renderTopicGrid();
    });

    const favFilterBtn = this.querySelector("#fc-fav-filter");
    if (favFilterBtn) {
      favFilterBtn.addEventListener("click", () => {
        this.showFavoritesOnly = !this.showFavoritesOnly;
        this.renderTopicGrid();
      });
    }

    this.querySelector("#fc-start")!.addEventListener("click", () => {
      if (totalSelected > 0) this.startPractice();
    });
  }

  startPractice() {
    this.cards = [];
    for (const i of this.selectedTopics) this.cards.push(...TOPICS[i].words);
    if (this.showFavoritesOnly) {
      this.cards = this.cards.filter(c => this.isFavorite(c));
    }
    if (this.cards.length === 0) return;

    // Spaced repetition: prioritize unseen and difficult cards
    const indices = [...Array(this.cards.length).keys()];
    this.shuffle(indices);
    indices.sort((a, b) => {
      const pa = this.getProgress(this.cards[a]);
      const pb = this.getProgress(this.cards[b]);
      // Unseen (ease=0) first, then again (1), hard (2), easy (3)
      if (pa.ease !== pb.ease) return pa.ease - pb.ease;
      // Within same ease, older reviews first
      return pa.lastSeen - pb.lastSeen;
    });
    this.order = indices;

    this.showDutchFirst = this.order.map(() => {
      if (this.direction === "nl-en" || this.direction === "listen" || this.direction === "dictation") return true;
      if (this.direction === "en-nl") return false;
      return Math.random() < 0.5;
    });
    this.current = 0;
    this.flipped = false;
    this.correctCount = 0;
    this.totalAnswered = 0;
    this.bindKeys();
    this.renderCard();
  }

  reshuffle() {
    this.order = this.shuffle([...Array(this.cards.length).keys()]);
    this.showDutchFirst = this.order.map(() => {
      if (this.direction === "nl-en" || this.direction === "listen" || this.direction === "dictation") return true;
      if (this.direction === "en-nl") return false;
      return Math.random() < 0.5;
    });
    this.current = 0;
    this.flipped = false;
    // Preserve correctCount and totalAnswered so reshuffle doesn't erase progress
    this.renderCard();
  }

  checkAnswer(input: string, correct: string): boolean {
    const normalize = (s: string) =>
      s.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
       .toLowerCase().trim().replace(/[?!.,;:'"]/g, "");
    return normalize(input) === normalize(correct);
  }

  submitDictation() {
    if (this.flipped) return;
    const input = this.querySelector<HTMLInputElement>(".fc-dictation-input");
    if (!input) return;
    const userAnswer = input.value;
    const card = this.cards[this.order[this.current]];
    const isCorrect = this.checkAnswer(userAnswer, card.dutch);
    this.totalAnswered++;
    if (isCorrect) this.correctCount++;
    this.flipped = true;
    this.renderCard(userAnswer);
  }

  renderCard(dictationAnswer?: string) {
    const total = this.order.length;

    if (this.current >= total) {
      this.unbindKeys();
      const isDictation = this.direction === "dictation";
      const scorePct = this.totalAnswered > 0 ? Math.round((this.correctCount / this.totalAnswered) * 100) : 0;
      const { totalReviews, streak } = this.storage.stats;
      this.innerHTML = `
        <div class="fc-container fc-center">
          <h2 class="fc-heading">All done!</h2>
          <p class="fc-subheading">You reviewed all ${total} cards.</p>
          ${isDictation ? `<p class="fc-score-final">${this.correctCount} / ${this.totalAnswered} correct (${scorePct}%)</p>` : ""}
          ${totalReviews > 0 ? `<p class="fc-lifetime-stats">${totalReviews} lifetime reviews${streak > 1 ? ` · ${streak}-day streak` : ""}</p>` : ""}
          <div class="fc-actions">
            <button class="fc-btn fc-btn-secondary" id="fc-back" type="button">Back to Topics</button>
            <button class="fc-btn fc-btn-primary" id="fc-restart" type="button">Restart</button>
          </div>
        </div>`;
      this.querySelector("#fc-back")!.addEventListener("click", () => this.renderTopicGrid());
      this.querySelector("#fc-restart")!.addEventListener("click", () => this.startPractice());
      return;
    }

    const card = this.cards[this.order[this.current]];
    const dutch = this.showDutchFirst[this.current];
    const isListen = this.direction === "listen";
    const isDictation = this.direction === "dictation";
    const num = this.current + 1;
    const pct = Math.round((this.current / total) * 100);

    let cardInner: string;

    if (isDictation && !this.flipped) {
      // Dictation mode front: audio button + text input + check button
      cardInner = `
        <div class="fc-card-inner">
          <div class="fc-lang-badge">DICTATION</div>
          <button class="dutch-audio-btn fc-audio-btn fc-listen-btn" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${FlashcardApp.SVG}</button>
          <div class="fc-dictation-form">
            <label for="fc-dictation-field" class="sr-only">Type what you hear</label>
            <input type="text" id="fc-dictation-field" class="fc-dictation-input" placeholder="Type what you hear..." autocomplete="off" autocapitalize="off" spellcheck="false" />
            <button class="fc-btn fc-btn-primary fc-dictation-check" type="button">Check Answer</button>
          </div>
        </div>`;
    } else if (isDictation && this.flipped) {
      // Dictation mode back: show result
      const userAnswer = dictationAnswer ?? "";
      const isCorrect = this.checkAnswer(userAnswer, card.dutch);
      cardInner = `
        <div class="fc-card-inner">
          <div class="fc-dictation-result ${isCorrect ? "fc-dictation-correct" : "fc-dictation-wrong"}">
            <div class="fc-dictation-status">${isCorrect ? "&#10003; Correct!" : "&#10007; Incorrect"}</div>
            ${!isCorrect ? `<div class="fc-dictation-your">Your answer: <span class="fc-dictation-diff">${this.esc(userAnswer) || "(empty)"}</span></div>` : ""}
            <div class="fc-dictation-answer">
              <span>${this.esc(card.dutch)}</span>
              <button class="dutch-audio-btn fc-audio-btn" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${FlashcardApp.SVG}</button>
            </div>
            ${card.ipa ? `<div class="fc-ipa">${this.esc(card.ipa)}</div>` : ""}
            <div class="fc-divider"></div>
            <div class="fc-lang-badge fc-lang-badge-answer">EN</div>
            <div class="fc-answer">${this.esc(card.english)}</div>
          </div>
        </div>`;
    } else if (isListen && !this.flipped) {
      // Listen mode front: only audio button + "?"
      cardInner = `
        <div class="fc-card-inner">
          <div class="fc-lang-badge">LISTEN</div>
          <button class="dutch-audio-btn fc-audio-btn fc-listen-btn" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${FlashcardApp.SVG}</button>
          <div class="fc-listen-hint">?</div>
        </div>`;
    } else if (isListen && this.flipped) {
      // Listen mode back: show Dutch + English + IPA
      cardInner = `
        <div class="fc-card-inner">
          <div class="fc-lang-badge">NL</div>
          <div class="fc-word">${this.esc(card.dutch)}</div>
          ${card.ipa ? `<div class="fc-ipa">${this.esc(card.ipa)}</div>` : ""}
          <button class="dutch-audio-btn fc-audio-btn" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${FlashcardApp.SVG}</button>
          <div class="fc-divider"></div>
          <div class="fc-lang-badge fc-lang-badge-answer">EN</div>
          <div class="fc-answer">${this.esc(card.english)}</div>
        </div>`;
    } else {
      // Normal modes
      const frontWord = dutch ? card.dutch : card.english;
      const frontSub = dutch && card.ipa ? `<div class="fc-ipa">${this.esc(card.ipa)}</div>` : "";
      const frontAudio = dutch
        ? `<button class="dutch-audio-btn fc-audio-btn" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${FlashcardApp.SVG}</button>`
        : "";
      const frontLabel = dutch ? "NL" : "EN";

      const backWord = dutch ? card.english : card.dutch;
      const backSub = !dutch && card.ipa ? `<div class="fc-ipa">${this.esc(card.ipa)}</div>` : "";
      const backAudio = !dutch
        ? `<button class="dutch-audio-btn fc-audio-btn" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${FlashcardApp.SVG}</button>`
        : "";
      const backLabel = dutch ? "EN" : "NL";

      cardInner = `
        <div class="fc-card-inner">
          <div class="fc-lang-badge">${frontLabel}</div>
          <div class="fc-word">${this.esc(frontWord)}</div>
          ${frontSub}
          ${frontAudio}
          ${this.flipped ? `
            <div class="fc-divider"></div>
            <div class="fc-lang-badge fc-lang-badge-answer">${backLabel}</div>
            <div class="fc-answer">${this.esc(backWord)}</div>
            ${backSub}
            ${backAudio}
          ` : ""}
        </div>`;
    }

    /* Build word list for the bottom panel */
    const wordListRows = this.order.map((idx, pos) => {
      const w = this.cards[idx];
      const isDutchFirst = this.showDutchFirst[pos];
      const isCurrent = pos === this.current;
      const visited = pos < this.current;
      const cls = isCurrent ? "fc-wl-current" : visited ? "fc-wl-visited" : "";
      /* Show only the "question" side; hover reveals answer */
      const shown = (isListen || isDictation) ? "..." : (isDutchFirst ? this.esc(w.dutch) : this.esc(w.english));
      const hidden = isDutchFirst ? this.esc(w.english) : this.esc(w.dutch);
      return `<tr class="${cls}" data-pos="${pos}"><td class="fc-wl-num">${pos + 1}</td><td class="fc-wl-shown">${shown}</td><td class="fc-wl-hidden">${hidden}</td></tr>`;
    }).join("");

    const fav = this.isFavorite(card);

    this.innerHTML = `
      <div class="fc-container">
        <div class="fc-toolbar">
          <button class="fc-btn fc-btn-small fc-btn-secondary" id="fc-back" type="button">Back</button>
          <span class="fc-counter">${isDictation && this.totalAnswered > 0 ? `<span class="fc-score" aria-live="polite">${this.correctCount}/${this.totalAnswered}</span> · ` : ""}${num} / ${total}</span>
          <div class="fc-toolbar-right">
            <button class="fc-fav-btn ${fav ? "fc-fav-on" : ""}" id="fc-fav" type="button" title="${fav ? "Remove from favorites" : "Add to favorites"}" aria-label="${fav ? "Remove from favorites" : "Add to favorites"}">${FlashcardApp.HEART}</button>
            <button class="fc-btn fc-btn-small fc-btn-secondary" id="fc-reshuffle" type="button" title="Reshuffle cards">Shuffle</button>
          </div>
        </div>
        <div class="fc-progress-bar" role="progressbar" aria-valuenow="${pct}" aria-valuemin="0" aria-valuemax="100"><div class="fc-progress-fill" style="width:${pct}%"></div></div>

        <div class="fc-card-row">
          <button class="fc-nav fc-nav-prev ${this.current === 0 ? "fc-nav-disabled" : ""}" id="fc-prev" type="button" title="Previous card" aria-label="Previous card">&#8249;</button>
          <div class="fc-card" id="fc-card">
            ${cardInner}
          </div>
          <button class="fc-nav fc-nav-next" id="fc-next" type="button" title="${this.flipped ? "Next card" : "Show Answer"}" aria-label="Next">&#8250;</button>
        </div>

        ${this.flipped ? `
        <div class="fc-rating" aria-label="Rate difficulty">
          <button class="fc-rate-btn fc-rate-again" data-ease="1" type="button">Again</button>
          <button class="fc-rate-btn fc-rate-hard" data-ease="2" type="button">Hard</button>
          <button class="fc-rate-btn fc-rate-easy" data-ease="3" type="button">Easy</button>
        </div>` : ""}

        <div class="fc-shortcut-hint">&larr; Prev &nbsp; Space / Enter &nbsp; Next &rarr;</div>

        <details class="fc-wordlist-toggle">
          <summary class="fc-wl-summary">All words (${total})</summary>
          <div class="fc-wordlist-wrap">
            <table class="fc-wordlist"><tbody>${wordListRows}</tbody></table>
          </div>
        </details>
      </div>`;

    this.querySelector("#fc-next")!.addEventListener("click", () => this.advance());
    this.querySelector("#fc-prev")!.addEventListener("click", () => {
      if (this.current > 0) { this.current--; this.flipped = false; this.renderCard(); }
    });
    this.querySelector("#fc-card")!.addEventListener("click", (e) => {
      if ((e.target as Element).closest(".dutch-audio-btn")) return;
      if ((e.target as Element).closest(".fc-dictation-form")) return;
      if (isDictation && !this.flipped) return;
      this.advance();
    });
    this.querySelector("#fc-back")!.addEventListener("click", () => { this.unbindKeys(); this.renderTopicGrid(); });
    this.querySelector("#fc-reshuffle")!.addEventListener("click", () => this.reshuffle());
    this.querySelector("#fc-fav")!.addEventListener("click", () => {
      this.toggleFavorite(card);
      this.renderCard();
    });
    this.querySelectorAll<HTMLButtonElement>(".fc-rate-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        this.rateCard(card, Number(btn.dataset.ease));
        this.current++;
        this.flipped = false;
        this.renderCard();
      });
    });

    // Dictation mode: wire up check button and Enter key on input
    if (isDictation && !this.flipped) {
      const checkBtn = this.querySelector(".fc-dictation-check");
      if (checkBtn) checkBtn.addEventListener("click", () => this.submitDictation());
      const input = this.querySelector<HTMLInputElement>(".fc-dictation-input");
      if (input) {
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") { e.preventDefault(); this.submitDictation(); }
        });
        requestAnimationFrame(() => input.focus());
      }
    }

    // Auto-play in Listen and Dictation mode
    if ((isListen || isDictation) && !this.flipped) {
      setTimeout(() => speakDutch(card.dutch), 150);
    }

    /* Click word list row to jump to that card */
    this.querySelectorAll<HTMLTableRowElement>(".fc-wordlist tr[data-pos]").forEach(row => {
      row.addEventListener("click", () => {
        this.current = Number(row.dataset.pos);
        this.flipped = false;
        this.renderCard();
      });
    });

    /* Auto-scroll word list to keep current card visible */
    const currentRow = this.querySelector<HTMLTableRowElement>(".fc-wl-current");
    if (currentRow) currentRow.scrollIntoView({ block: "nearest", behavior: "smooth" });
  }
}

customElements.define("flashcard-app", FlashcardApp);
</script>

<style>
  .fc-container { max-width: 640px; margin: 0 auto; }
  .fc-center { text-align: center; }
  .fc-heading { font-size: var(--sl-text-h4); font-weight: 700; margin: 0 0 0.25rem; color: var(--sl-color-white); line-height: var(--sl-line-height-headings); }
  .fc-subheading { margin: 0 0 1.25rem; color: var(--sl-color-gray-3); font-size: var(--sl-text-sm); }

  /* topic grid */
  .fc-topic-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 0.65rem; margin-bottom: 1rem;
  }
  .fc-topic-card {
    position: relative; display: flex; flex-direction: column; align-items: flex-start;
    gap: 0.15rem; padding: 0.75rem 0.85rem; border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem; background: var(--sl-color-black); cursor: pointer; text-align: left;
    color: var(--sl-color-white); box-shadow: var(--sl-shadow-sm);
    transition: border-color 0.15s, background-color 0.15s;
  }
  .fc-topic-card:hover { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); }
  .fc-topic-card.fc-topic-selected { border-color: var(--sl-color-accent); background-color: var(--sl-color-accent-low); }
  .fc-topic-check { position: absolute; top: 0.45rem; right: 0.6rem; font-size: var(--sl-text-sm); font-weight: 700; color: var(--sl-color-accent-high); line-height: 1; }
  .fc-topic-name { font-weight: 600; font-size: var(--sl-text-sm); line-height: 1.25; }
  .fc-topic-count { font-size: var(--sl-text-xs); color: var(--sl-color-gray-3); }

  /* direction picker */
  .fc-direction { display: flex; gap: 0.4rem; justify-content: center; margin-bottom: 1.25rem; flex-wrap: wrap; }
  .fc-dir-btn {
    padding: 0.4rem 0.9rem; border-radius: 999rem; font-size: var(--sl-text-xs); font-weight: 600;
    cursor: pointer; border: 1px solid var(--sl-color-gray-5); background: none;
    color: var(--sl-color-white); transition: all 0.15s;
  }
  .fc-dir-btn:hover { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); }
  .fc-dir-btn.fc-dir-active { background: var(--sl-color-text-accent); color: var(--sl-color-black); border-color: var(--sl-color-text-accent); }

  /* actions */
  .fc-actions { display: flex; gap: 0.65rem; justify-content: center; flex-wrap: wrap; }

  /* buttons */
  .fc-btn {
    padding: 0.55rem 1.4rem; border-radius: 999rem; font-size: var(--sl-text-sm); font-weight: 600;
    cursor: pointer; border: 1px solid var(--sl-color-gray-5); background: none;
    color: var(--sl-color-white); transition: background-color 0.15s, opacity 0.15s;
  }
  .fc-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .fc-btn-primary { background: var(--sl-color-text-accent); color: var(--sl-color-black); border-color: var(--sl-color-text-accent); }
  .fc-btn-primary:hover:not(:disabled) { opacity: 0.88; }
  .fc-btn-secondary:hover:not(:disabled) { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); }
  .fc-btn-small { padding: 0.3rem 0.85rem; font-size: var(--sl-text-xs); }

  /* toolbar */
  .fc-toolbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
  .fc-counter { font-size: var(--sl-text-xs); color: var(--sl-color-gray-3); font-variant-numeric: tabular-nums; }

  /* progress */
  .fc-progress-bar { width: 100%; height: 4px; border-radius: 2px; background: var(--sl-color-gray-5); margin-bottom: 1.25rem; overflow: hidden; }
  .fc-progress-fill { height: 100%; border-radius: 2px; background: var(--sl-color-accent); transition: width 0.3s ease; }

  /* card row with nav arrows */
  .fc-card-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; }
  .fc-nav {
    flex-shrink: 0; width: 40px; height: 80px; display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem; line-height: 1; border: 1px solid var(--sl-color-gray-5); border-radius: 0.5rem;
    background: none; color: var(--sl-color-gray-3); cursor: pointer; transition: all 0.15s;
    user-select: none;
  }
  .fc-nav:hover:not(.fc-nav-disabled) { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); color: var(--sl-color-white); }
  .fc-nav-disabled { opacity: 0.2; cursor: default; }

  /* card */
  .fc-card {
    flex: 1; min-width: 0;
    border: 1px solid var(--sl-color-gray-5); border-radius: 0.5rem;
    padding: 2rem 1.5rem; min-height: 200px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    text-align: center; background: var(--sl-color-black);
    box-shadow: var(--sl-shadow-sm); transition: border-color 0.2s, background-color 0.2s;
  }
  .fc-card:hover { border-color: var(--sl-color-gray-2); background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); }
  .fc-card-inner { width: 100%; }
  .fc-lang-badge {
    display: inline-block; font-size: var(--sl-text-2xs); font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.05em; padding: 0.15rem 0.5rem; border-radius: 0.25rem;
    background: var(--sl-color-gray-5); color: var(--sl-color-gray-2); margin-bottom: 0.5rem;
  }
  .fc-lang-badge-answer { background: var(--sl-color-accent-low); color: var(--sl-color-accent-high); }
  .fc-word { font-size: 1.75rem; font-weight: 700; color: var(--sl-color-white); margin-bottom: 0.3rem; line-height: var(--sl-line-height-headings); }
  .fc-ipa { font-size: var(--sl-text-sm); color: var(--sl-color-gray-3); margin-bottom: 0.5rem; }
  .fc-audio-btn {
    display: inline-flex; align-items: center; justify-content: center; padding: 0.4rem;
    border: 1px solid var(--sl-color-gray-5); border-radius: 0.25rem; background: none;
    color: var(--sl-color-text-accent); cursor: pointer; transition: background-color 0.15s;
  }
  .fc-audio-btn:hover { background-color: var(--sl-color-accent-low); }
  .fc-divider { width: 60px; height: 1px; background: var(--sl-color-gray-5); margin: 1rem auto; }
  .fc-answer { font-size: 1.4rem; font-weight: 600; color: var(--sl-color-text-accent); margin-bottom: 0.2rem; }
  .fc-shortcut-hint { text-align: center; font-size: var(--sl-text-2xs); color: var(--sl-color-gray-3); margin-bottom: 1rem; }

  /* listen mode */
  .fc-listen-btn { transform: scale(2); margin: 1rem 0; }
  .fc-listen-hint { font-size: 2.5rem; font-weight: 700; color: var(--sl-color-gray-3); margin-top: 0.75rem; }

  /* dictation mode */
  .fc-dictation-form { display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1rem; width: 100%; }
  .fc-dictation-input {
    width: 100%; padding: 0.65rem 0.85rem; font-size: 1.1rem; font-family: inherit;
    border: 2px solid var(--sl-color-gray-5); border-radius: 0.5rem;
    background: var(--sl-color-black); color: var(--sl-color-white);
    text-align: center; outline: none; transition: border-color 0.15s;
    box-sizing: border-box;
  }
  .fc-dictation-input:focus { border-color: var(--sl-color-text-accent); }
  .fc-dictation-input::placeholder { color: var(--sl-color-gray-3); }
  .fc-dictation-check { align-self: center; }
  .fc-dictation-result { width: 100%; }
  .fc-dictation-status { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.75rem; }
  .fc-dictation-correct .fc-dictation-status { color: #4ade80; }
  .fc-dictation-wrong .fc-dictation-status { color: #f87171; }
  .fc-dictation-your { font-size: var(--sl-text-sm); color: var(--sl-color-gray-3); margin-bottom: 0.5rem; }
  .fc-dictation-diff { color: #f87171; font-weight: 600; }
  .fc-dictation-answer { font-size: 1.4rem; font-weight: 700; color: var(--sl-color-white); margin-bottom: 0.25rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
  .fc-score { color: var(--sl-color-text-accent); font-weight: 600; }
  .fc-score-final { font-size: 1.25rem; font-weight: 700; color: var(--sl-color-text-accent); margin-bottom: 1.25rem; }

  /* word list panel */
  .fc-wordlist-toggle { margin-top: 0.5rem; }
  .fc-wl-summary {
    cursor: pointer; font-size: var(--sl-text-xs); font-weight: 600; color: var(--sl-color-gray-3);
    padding: 0.4rem 0; user-select: none;
  }
  .fc-wl-summary:hover { color: var(--sl-color-white); }
  .fc-wordlist-wrap { max-height: 300px; overflow-y: auto; margin-top: 0.5rem; }
  .fc-wordlist {
    width: 100%; border-collapse: collapse; font-size: var(--sl-text-xs);
  }
  .fc-wordlist tr { cursor: pointer; transition: background-color 0.1s; }
  .fc-wordlist tr:hover { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); }
  .fc-wordlist td { padding: 0.25rem 0.5rem; border-bottom: 1px solid var(--sl-color-gray-6); }
  .fc-wl-num { width: 2rem; color: var(--sl-color-gray-3); text-align: right; font-variant-numeric: tabular-nums; }
  .fc-wl-shown { color: var(--sl-color-white); }
  .fc-wl-hidden { color: transparent; transition: color 0.15s; }
  .fc-wordlist tr:hover .fc-wl-hidden { color: var(--sl-color-gray-3); }
  .fc-wl-current { background-color: var(--sl-color-accent-low); }
  .fc-wl-current td { font-weight: 600; }
  .fc-wl-visited { opacity: 0.5; }

  /* focus styles */
  .fc-btn:focus-visible, .fc-nav:focus-visible, .fc-dir-btn:focus-visible,
  .fc-topic-card:focus-visible, .fc-audio-btn:focus-visible, .fc-fav-btn:focus-visible,
  .fc-rate-btn:focus-visible {
    outline: 2px solid var(--sl-color-text-accent);
    outline-offset: 2px;
  }

  /* toolbar right group */
  .fc-toolbar-right { display: flex; align-items: center; gap: 0.4rem; }

  /* favorite button */
  .fc-fav-btn {
    display: inline-flex; align-items: center; justify-content: center; padding: 0.3rem;
    border: none; border-radius: 50%; background: none;
    color: var(--sl-color-gray-3); cursor: pointer; transition: color 0.15s, transform 0.15s;
  }
  .fc-fav-btn:hover { color: #f87171; transform: scale(1.15); }
  .fc-fav-btn.fc-fav-on { color: #ef4444; }
  .fc-fav-btn.fc-fav-on svg { fill: #ef4444; }

  /* favorites filter active */
  .fc-fav-active { background: #fecaca; color: #b91c1c !important; border-color: #fca5a5 !important; }

  /* rating buttons */
  .fc-rating {
    display: flex; gap: 0.5rem; justify-content: center; margin-bottom: 0.5rem;
  }
  .fc-rate-btn {
    padding: 0.35rem 1rem; border-radius: 999rem; font-size: var(--sl-text-xs); font-weight: 600;
    cursor: pointer; border: 1px solid var(--sl-color-gray-5); background: none;
    color: var(--sl-color-white); transition: all 0.15s;
  }
  .fc-rate-again { border-color: #f87171; color: #f87171; }
  .fc-rate-again:hover { background: #f87171; color: var(--sl-color-black); }
  .fc-rate-hard { border-color: #fbbf24; color: #fbbf24; }
  .fc-rate-hard:hover { background: #fbbf24; color: var(--sl-color-black); }
  .fc-rate-easy { border-color: #4ade80; color: #4ade80; }
  .fc-rate-easy:hover { background: #4ade80; color: var(--sl-color-black); }

  /* stats */
  .fc-stats-line { color: var(--sl-color-text-accent); font-weight: 600; }
  .fc-lifetime-stats { font-size: var(--sl-text-sm); color: var(--sl-color-gray-3); margin-bottom: 1rem; }

  /* screen-reader only */
  .sr-only {
    position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
    overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0;
  }
</style>
