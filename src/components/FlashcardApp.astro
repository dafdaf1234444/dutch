---
// FlashcardApp â€“ Dutch vocabulary flashcard practice.
// Five modes (Dutch->English, English->Dutch, Mixed, Listen, Dictation),
// spaced repetition, session tracking with end-of-session summary,
// review hard words, keyboard shortcuts, favorites, reshuffling.
// Redesigned: compact checkbox topic list, fixed 280px card, ratings inside card.
---

<flashcard-app id="flashcard-app"></flashcard-app>

<script>
import { speakDutch } from "../scripts/dutch-speech";
import { DECKS, type Word } from "../data/flashcard-decks";

/* Standalone audio handler for flashcard audio buttons */
document.addEventListener("click", (e) => {
  const btn = (e.target as Element).closest?.(".dutch-audio-btn") as HTMLButtonElement | null;
  if (!btn) return;
  const text = btn.dataset.text;
  if (!text) return;
  speakDutch(text, btn);
});
const TOPICS = DECKS;
const FC_STORAGE_KEY = "dutch-fc-progress";

type Direction = "nl-en" | "en-nl" | "mixed" | "listen" | "dictation";

interface CardProgress {
  ease: number;      // 0=new, 1=again, 2=hard, 3=easy
  lastSeen: number;  // timestamp
  reviews: number;
  favorite: boolean;
}

interface FCStorage {
  cards: Record<string, CardProgress>;
  stats: { totalReviews: number; lastDate: string; streak: number };
}

class FlashcardApp extends HTMLElement {
  selectedTopics: Set<number> = new Set();
  cards: Word[] = [];
  order: number[] = [];
  current = 0;
  flipped = false;
  direction: Direction = "mixed";
  /* per-card: true = show Dutch first, false = show English first */
  showDutchFirst: boolean[] = [];
  /* dictation scoring */
  correctCount = 0;
  totalAnswered = 0;
  /* progress & favorites */
  showFavoritesOnly = false;
  private storage: FCStorage = { cards: {}, stats: { totalReviews: 0, lastDate: "", streak: 0 } };
  /* session tracking: maps order index -> ease rating (1=again, 2=hard, 3=easy) */
  private sessionRatings: Map<number, number> = new Map();

  static SVG = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
  static HEART = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;

  private _keyHandler: ((e: KeyboardEvent) => void) | null = null;

  connectedCallback() {
    this.loadStorage();
    this.renderTopicGrid();
  }

  /* ---- Storage helpers ---- */

  private loadStorage(): void {
    try {
      const raw = localStorage.getItem(FC_STORAGE_KEY);
      if (raw) this.storage = JSON.parse(raw);
    } catch { /* localStorage unavailable */ }
  }

  private saveStorage(): void {
    try {
      localStorage.setItem(FC_STORAGE_KEY, JSON.stringify(this.storage));
    } catch { /* localStorage unavailable */ }
  }

  private cardKey(card: Word): string {
    return card.dutch.toLowerCase();
  }

  private getProgress(card: Word): CardProgress {
    return this.storage.cards[this.cardKey(card)] ?? { ease: 0, lastSeen: 0, reviews: 0, favorite: false };
  }

  private rateCard(card: Word, ease: number): void {
    const key = this.cardKey(card);
    const prev = this.storage.cards[key] ?? { ease: 0, lastSeen: 0, reviews: 0, favorite: false };
    this.storage.cards[key] = { ...prev, ease, lastSeen: Date.now(), reviews: prev.reviews + 1 };
    this.storage.stats.totalReviews++;
    const today = new Date().toISOString().slice(0, 10);
    const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
    if (this.storage.stats.lastDate !== today) {
      this.storage.stats.streak = this.storage.stats.lastDate === yesterday ? this.storage.stats.streak + 1 : 1;
      this.storage.stats.lastDate = today;
    }
    this.saveStorage();
  }

  private toggleFavorite(card: Word): void {
    const key = this.cardKey(card);
    const prev = this.storage.cards[key] ?? { ease: 0, lastSeen: 0, reviews: 0, favorite: false };
    this.storage.cards[key] = { ...prev, favorite: !prev.favorite };
    this.saveStorage();
  }

  private isFavorite(card: Word): boolean {
    return this.getProgress(card).favorite;
  }

  private getFavoritesCount(): number {
    return Object.values(this.storage.cards).filter(c => c.favorite).length;
  }

  private getTopicMastery(topicIndex: number): { total: number; easy: number; hard: number; again: number; unseen: number } {
    const words = TOPICS[topicIndex].words;
    let easy = 0, hard = 0, again = 0, unseen = 0;
    for (const w of words) {
      const p = this.getProgress(w);
      if (p.ease === 3) easy++;
      else if (p.ease === 2) hard++;
      else if (p.ease === 1) again++;
      else unseen++;
    }
    return { total: words.length, easy, hard, again, unseen };
  }

  shuffle<T>(arr: T[]): T[] {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  esc(s: string): string {
    return s.replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  }

  bindKeys() {
    this.unbindKeys();
    this._keyHandler = (e: KeyboardEvent) => {
      if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) return;
      if (e.key === " " || e.key === "Enter") {
        e.preventDefault();
        this.advance();
      } else if (e.key === "ArrowRight") {
        e.preventDefault();
        if (this.flipped) { this.current++; this.flipped = false; this.renderCard(); }
      } else if (e.key === "ArrowLeft") {
        e.preventDefault();
        if (this.current > 0) { this.current--; this.flipped = false; this.renderCard(); }
      } else if (this.flipped && (e.key === "1" || e.key === "2" || e.key === "3")) {
        e.preventDefault();
        const card = this.cards[this.order[this.current]];
        const ease = Number(e.key);
        this.rateCard(card, ease);
        this.sessionRatings.set(this.current, ease);
        this.current++;
        this.flipped = false;
        this.renderCard();
      }
    };
    document.addEventListener("keydown", this._keyHandler);
  }

  unbindKeys() {
    if (this._keyHandler) {
      document.removeEventListener("keydown", this._keyHandler);
      this._keyHandler = null;
    }
  }

  advance() {
    if (this.direction === "dictation") {
      if (!this.flipped) {
        this.submitDictation();
      } else {
        this.current++;
        this.flipped = false;
        this.renderCard();
      }
      return;
    }
    if (!this.flipped) {
      this.flipped = true;
      /* Auto-play Dutch audio when revealing Dutch side */
      const card = this.cards[this.order[this.current]];
      if (!this.showDutchFirst[this.current]) {
        speakDutch(card.dutch);
      }
      this.renderCard();
    } else {
      this.current++;
      this.flipped = false;
      this.renderCard();
    }
  }

  /* ---- topic selection screen ---- */

  renderTopicGrid() {
    this.unbindKeys();
    const totalSelected = [...this.selectedTopics].reduce(
      (sum, i) => sum + TOPICS[i].words.length, 0
    );

    const dirLabels: Record<Direction, string> = {
      "nl-en": "NL\u2192EN",
      "en-nl": "EN\u2192NL",
      "mixed": "Mixed",
      "listen": "Listen",
      "dictation": "Dictation",
    };

    const { totalReviews, streak } = this.storage.stats;
    const favCount = this.getFavoritesCount();
    const statsLine = totalReviews > 0
      ? `${totalReviews} reviews${streak > 1 ? ` \u00b7 ${streak}-day streak` : ""}`
      : "";

    const allSelected = this.selectedTopics.size === TOPICS.length;

    this.innerHTML = `
      <div class="fc-wrap">
        <div class="fc-top-row">
          <h2 class="fc-title">Flashcards</h2>
          ${statsLine ? `<span class="fc-stats-pill">${statsLine}</span>` : ""}
        </div>

        <div class="fc-dir-bar">
          ${(["nl-en", "en-nl", "mixed", "listen", "dictation"] as Direction[]).map(d => `
            <button class="fc-dir ${this.direction === d ? "fc-dir-on" : ""}"
                    data-dir="${d}" type="button">${dirLabels[d]}</button>
          `).join("")}
        </div>

        <div class="fc-topic-box">
          <label class="fc-topic-row fc-topic-all">
            <input type="checkbox" class="fc-check" id="fc-select-all" ${allSelected ? "checked" : ""} />
            <span class="fc-topic-name">Select All</span>
            <span class="fc-topic-count">${TOPICS.reduce((s, t) => s + t.words.length, 0)}</span>
          </label>
          <div class="fc-topic-divider"></div>
          <div class="fc-topic-scroll">
            ${TOPICS.map((t, i) => {
              const m = this.getTopicMastery(i);
              const masteryPct = m.total > 0 ? Math.round(((m.easy + m.hard) / m.total) * 100) : 0;
              const sel = this.selectedTopics.has(i);
              return `
              <label class="fc-topic-row ${sel ? "fc-topic-sel" : ""}" data-index="${i}">
                <input type="checkbox" class="fc-check fc-topic-check" data-index="${i}" ${sel ? "checked" : ""} />
                <span class="fc-topic-name">${t.name}</span>
                <span class="fc-topic-count">${t.words.length}</span>
                ${masteryPct > 0 ? `<span class="fc-topic-pct" title="${m.easy} easy, ${m.hard} hard, ${m.again} again, ${m.unseen} unseen">${masteryPct}%</span>` : `<span class="fc-topic-pct"></span>`}
                ${masteryPct > 0 ? `<div class="fc-mastery-bar"><div class="fc-mastery-fill fc-mastery-easy" style="width:${Math.round((m.easy / m.total) * 100)}%"></div><div class="fc-mastery-fill fc-mastery-hard" style="width:${Math.round((m.hard / m.total) * 100)}%"></div><div class="fc-mastery-fill fc-mastery-again" style="width:${Math.round((m.again / m.total) * 100)}%"></div></div>` : ""}
              </label>`;
            }).join("")}
          </div>
        </div>

        <div class="fc-bottom-bar">
          ${favCount > 0 ? `<button class="fc-fav-filter ${this.showFavoritesOnly ? "fc-fav-filter-on" : ""}" id="fc-fav-filter" type="button">&#9829; ${favCount}</button>` : ""}
          <button class="fc-start" id="fc-start" type="button" ${totalSelected === 0 ? "disabled" : ""}>
            Start${totalSelected > 0 ? ` (${totalSelected})` : ""}
          </button>
        </div>
      </div>`;

    // Wire topic checkboxes
    this.querySelectorAll<HTMLInputElement>(".fc-topic-check").forEach(cb => {
      cb.addEventListener("change", () => {
        const idx = Number(cb.dataset.index);
        if (cb.checked) this.selectedTopics.add(idx);
        else this.selectedTopics.delete(idx);
        this.renderTopicGrid();
      });
    });

    // Wire Select All
    this.querySelector("#fc-select-all")!.addEventListener("change", () => {
      if (allSelected) this.selectedTopics.clear();
      else TOPICS.forEach((_, i) => this.selectedTopics.add(i));
      this.renderTopicGrid();
    });

    // Direction buttons
    this.querySelectorAll<HTMLButtonElement>(".fc-dir").forEach(btn => {
      btn.addEventListener("click", () => {
        this.direction = btn.dataset.dir as Direction;
        this.renderTopicGrid();
      });
    });

    // Favorites filter
    const favBtn = this.querySelector("#fc-fav-filter");
    if (favBtn) {
      favBtn.addEventListener("click", () => {
        this.showFavoritesOnly = !this.showFavoritesOnly;
        this.renderTopicGrid();
      });
    }

    // Start
    this.querySelector("#fc-start")!.addEventListener("click", () => {
      if (totalSelected > 0) this.startPractice();
    });
  }

  startPractice() {
    this.cards = [];
    for (const i of this.selectedTopics) this.cards.push(...TOPICS[i].words);
    if (this.showFavoritesOnly) {
      this.cards = this.cards.filter(c => this.isFavorite(c));
    }
    if (this.cards.length === 0) return;

    // Spaced repetition: prioritize unseen and difficult cards
    const indices = [...Array(this.cards.length).keys()];
    this.shuffle(indices);
    indices.sort((a, b) => {
      const pa = this.getProgress(this.cards[a]);
      const pb = this.getProgress(this.cards[b]);
      if (pa.ease !== pb.ease) return pa.ease - pb.ease;
      return pa.lastSeen - pb.lastSeen;
    });
    this.order = indices;

    this.showDutchFirst = this.order.map(() => {
      if (this.direction === "nl-en" || this.direction === "listen" || this.direction === "dictation") return true;
      if (this.direction === "en-nl") return false;
      return Math.random() < 0.5;
    });
    this.current = 0;
    this.flipped = false;
    this.correctCount = 0;
    this.totalAnswered = 0;
    this.sessionRatings = new Map();
    this.bindKeys();
    this.renderCard();
  }

  startPracticeWithCards(cardIndices: number[]) {
    this.order = this.shuffle([...cardIndices]);
    this.showDutchFirst = this.order.map(() => {
      if (this.direction === "nl-en" || this.direction === "listen" || this.direction === "dictation") return true;
      if (this.direction === "en-nl") return false;
      return Math.random() < 0.5;
    });
    this.current = 0;
    this.flipped = false;
    this.correctCount = 0;
    this.totalAnswered = 0;
    this.sessionRatings = new Map();
    this.bindKeys();
    this.renderCard();
  }

  reshuffle() {
    this.order = this.shuffle([...Array(this.cards.length).keys()]);
    this.showDutchFirst = this.order.map(() => {
      if (this.direction === "nl-en" || this.direction === "listen" || this.direction === "dictation") return true;
      if (this.direction === "en-nl") return false;
      return Math.random() < 0.5;
    });
    this.current = 0;
    this.flipped = false;
    this.renderCard();
  }

  checkAnswer(input: string, correct: string): boolean {
    const normalize = (s: string) =>
      s.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
       .toLowerCase().trim().replace(/[?!.,;:'"]/g, "");
    return normalize(input) === normalize(correct);
  }

  submitDictation() {
    if (this.flipped) return;
    const input = this.querySelector<HTMLInputElement>(".fc-dict-input");
    if (!input) return;
    const userAnswer = input.value;
    const card = this.cards[this.order[this.current]];
    const isCorrect = this.checkAnswer(userAnswer, card.dutch);
    this.totalAnswered++;
    if (isCorrect) {
      this.correctCount++;
      this.sessionRatings.set(this.current, 3);
      this.rateCard(card, 3);
    } else {
      this.sessionRatings.set(this.current, 1);
      this.rateCard(card, 1);
    }
    this.flipped = true;
    this.renderCard(userAnswer);
  }

  renderCard(dictationAnswer?: string) {
    const total = this.order.length;

    if (this.current >= total) {
      this.renderSummary();
      return;
    }

    const card = this.cards[this.order[this.current]];
    const dutch = this.showDutchFirst[this.current];
    const isListen = this.direction === "listen";
    const isDictation = this.direction === "dictation";
    const num = this.current + 1;
    const pct = Math.round((this.current / total) * 100);
    const fav = this.isFavorite(card);

    /* Build the card face content (top section of the fixed card) */
    let faceHTML: string;

    if (isDictation && !this.flipped) {
      faceHTML = `
        <div class="fc-badge">DICTATION</div>
        <button class="dutch-audio-btn fc-audio fc-audio-big" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${FlashcardApp.SVG}</button>
        <div class="fc-dict-form">
          <label for="fc-dict-field" class="sr-only">Type what you hear</label>
          <input type="text" id="fc-dict-field" class="fc-dict-input" placeholder="Type what you hear..." autocomplete="off" autocapitalize="off" spellcheck="false" />
          <button class="fc-dict-check" type="button">Check</button>
        </div>`;
    } else if (isDictation && this.flipped) {
      const userAnswer = dictationAnswer ?? "";
      const isCorrect = this.checkAnswer(userAnswer, card.dutch);
      faceHTML = `
        <div class="fc-dict-result ${isCorrect ? "fc-dict-ok" : "fc-dict-no"}">
          <span class="fc-dict-status">${isCorrect ? "\u2713 Correct" : "\u2717 Incorrect"}</span>
          ${!isCorrect ? `<span class="fc-dict-yours">${this.esc(userAnswer) || "(empty)"}</span>` : ""}
        </div>
        <div class="fc-word-sm">${this.esc(card.dutch)}
          <button class="dutch-audio-btn fc-audio" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${FlashcardApp.SVG}</button>
        </div>
        ${card.ipa ? `<div class="fc-ipa">${this.esc(card.ipa)}</div>` : ""}
        <div class="fc-divider"></div>
        <div class="fc-answer">${this.esc(card.english)}</div>`;
    } else if (isListen && !this.flipped) {
      faceHTML = `
        <div class="fc-badge">LISTEN</div>
        <button class="dutch-audio-btn fc-audio fc-audio-big" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${FlashcardApp.SVG}</button>
        <div class="fc-listen-q">?</div>`;
    } else if (isListen && this.flipped) {
      faceHTML = `
        <div class="fc-badge">NL</div>
        <div class="fc-word">${this.esc(card.dutch)}</div>
        ${card.ipa ? `<div class="fc-ipa">${this.esc(card.ipa)}</div>` : ""}
        <button class="dutch-audio-btn fc-audio" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${FlashcardApp.SVG}</button>
        <div class="fc-divider"></div>
        <div class="fc-badge fc-badge-ans">EN</div>
        <div class="fc-answer">${this.esc(card.english)}</div>`;
    } else {
      /* Normal NL-EN / EN-NL / Mixed */
      const frontWord = dutch ? card.dutch : card.english;
      const frontIPA = dutch && card.ipa ? `<div class="fc-ipa">${this.esc(card.ipa)}</div>` : "";
      const frontAudio = dutch ? `<button class="dutch-audio-btn fc-audio" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${FlashcardApp.SVG}</button>` : "";
      const fLabel = dutch ? "NL" : "EN";

      const backWord = dutch ? card.english : card.dutch;
      const backIPA = !dutch && card.ipa ? `<div class="fc-ipa">${this.esc(card.ipa)}</div>` : "";
      const backAudio = !dutch ? `<button class="dutch-audio-btn fc-audio" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${FlashcardApp.SVG}</button>` : "";
      const bLabel = dutch ? "EN" : "NL";

      faceHTML = `
        <div class="fc-badge">${fLabel}</div>
        <div class="fc-word">${this.esc(frontWord)}</div>
        ${frontIPA}
        ${frontAudio}
        ${this.flipped ? `
          <div class="fc-divider"></div>
          <div class="fc-badge fc-badge-ans">${bLabel}</div>
          <div class="fc-answer">${this.esc(backWord)}</div>
          ${backIPA}
          ${backAudio}
        ` : ""}`;
    }

    /* Bottom zone: rating buttons (when flipped) or hint (when not) */
    let bottomHTML: string;
    if (isDictation && this.flipped) {
      /* Dictation result already shown; just Next button */
      bottomHTML = `<button class="fc-next-btn" id="fc-advance" type="button">Next</button>`;
    } else if (this.flipped) {
      bottomHTML = `
        <div class="fc-rate-row">
          <button class="fc-rate fc-rate-again" data-ease="1" type="button"><span class="fc-rate-key">1</span> Again</button>
          <button class="fc-rate fc-rate-hard" data-ease="2" type="button"><span class="fc-rate-key">2</span> Hard</button>
          <button class="fc-rate fc-rate-easy" data-ease="3" type="button"><span class="fc-rate-key">3</span> Easy</button>
        </div>`;
    } else if (isDictation) {
      bottomHTML = "";
    } else {
      bottomHTML = `<div class="fc-hint">Tap card or press Space</div>`;
    }

    this.innerHTML = `
      <div class="fc-wrap">
        <div class="fc-toolbar">
          <button class="fc-tbtn" id="fc-back" type="button">Back</button>
          <span class="fc-count">${isDictation && this.totalAnswered > 0 ? `<span class="fc-score">${this.correctCount}/${this.totalAnswered}</span> \u00b7 ` : ""}${num}/${total}</span>
          <div class="fc-toolbar-r">
            <button class="fc-fav-btn ${fav ? "fc-fav-on" : ""}" id="fc-fav" type="button" title="${fav ? "Remove favorite" : "Add favorite"}" aria-label="${fav ? "Remove from favorites" : "Add to favorites"}">${FlashcardApp.HEART}</button>
            <button class="fc-tbtn" id="fc-reshuffle" type="button">Shuffle</button>
          </div>
        </div>
        <div class="fc-pbar"><div class="fc-pfill" style="width:${pct}%"></div></div>

        <div class="fc-card-row">
          <button class="fc-nav ${this.current === 0 ? "fc-nav-off" : ""}" id="fc-prev" type="button" aria-label="Previous">&#8249;</button>
          <div class="fc-card" id="fc-card">
            <div class="fc-face">${faceHTML}</div>
            <div class="fc-bottom">${bottomHTML}</div>
          </div>
          <button class="fc-nav" id="fc-next" type="button" aria-label="Next">&#8250;</button>
        </div>

        <div class="fc-keys">&larr; Prev &nbsp; Space/Enter &nbsp; Next &rarr;${this.flipped ? " &nbsp; 1-2-3 Rate" : ""}</div>
      </div>`;

    /* Event wiring */
    this.querySelector("#fc-next")!.addEventListener("click", () => this.advance());
    this.querySelector("#fc-prev")!.addEventListener("click", () => {
      if (this.current > 0) { this.current--; this.flipped = false; this.renderCard(); }
    });
    this.querySelector("#fc-card")!.addEventListener("click", (e) => {
      if ((e.target as Element).closest(".dutch-audio-btn")) return;
      if ((e.target as Element).closest(".fc-dict-form")) return;
      if ((e.target as Element).closest(".fc-rate-row")) return;
      if ((e.target as Element).closest(".fc-next-btn")) return;
      if (isDictation && !this.flipped) return;
      this.advance();
    });
    this.querySelector("#fc-back")!.addEventListener("click", () => { this.unbindKeys(); this.renderTopicGrid(); });
    this.querySelector("#fc-reshuffle")!.addEventListener("click", () => this.reshuffle());
    this.querySelector("#fc-fav")!.addEventListener("click", () => {
      this.toggleFavorite(card);
      this.renderCard();
    });

    // Rating buttons
    this.querySelectorAll<HTMLButtonElement>(".fc-rate").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const ease = Number(btn.dataset.ease);
        this.rateCard(card, ease);
        this.sessionRatings.set(this.current, ease);
        this.current++;
        this.flipped = false;
        this.renderCard();
      });
    });

    // Dictation advance button
    const advBtn = this.querySelector("#fc-advance");
    if (advBtn) {
      advBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        this.current++;
        this.flipped = false;
        this.renderCard();
      });
    }

    // Dictation mode: wire up check button and Enter key on input
    if (isDictation && !this.flipped) {
      const checkBtn = this.querySelector(".fc-dict-check");
      if (checkBtn) checkBtn.addEventListener("click", () => this.submitDictation());
      const input = this.querySelector<HTMLInputElement>(".fc-dict-input");
      if (input) {
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") { e.preventDefault(); this.submitDictation(); }
        });
        requestAnimationFrame(() => input.focus());
      }
    }

    // Auto-play in Listen and Dictation mode
    if ((isListen || isDictation) && !this.flipped) {
      setTimeout(() => speakDutch(card.dutch), 150);
    }
  }

  renderSummary() {
    this.unbindKeys();
    const total = this.order.length;
    const isDictation = this.direction === "dictation";

    let easyCount = 0, hardCount = 0, againCount = 0, unratedCount = 0;
    for (let i = 0; i < total; i++) {
      const rating = this.sessionRatings.get(i);
      if (rating === 3) easyCount++;
      else if (rating === 2) hardCount++;
      else if (rating === 1) againCount++;
      else unratedCount++;
    }

    const hardCards: number[] = [];
    for (let i = 0; i < total; i++) {
      const rating = this.sessionRatings.get(i);
      if (rating === 1 || rating === 2) hardCards.push(this.order[i]);
    }

    const { totalReviews, streak } = this.storage.stats;
    const scorePct = isDictation && this.totalAnswered > 0 ? Math.round((this.correctCount / this.totalAnswered) * 100) : 0;

    const summaryRows = this.order.map((idx, pos) => {
      const w = this.cards[idx];
      const rating = this.sessionRatings.get(pos);
      let ratingLabel = "", ratingClass = "";
      if (rating === 3) { ratingLabel = "Easy"; ratingClass = "fc-sr-easy"; }
      else if (rating === 2) { ratingLabel = "Hard"; ratingClass = "fc-sr-hard"; }
      else if (rating === 1) { ratingLabel = "Again"; ratingClass = "fc-sr-again"; }
      else { ratingLabel = "\u2014"; ratingClass = "fc-sr-skip"; }
      return `<tr class="${ratingClass}">
        <td class="fc-sr-nl">${this.esc(w.dutch)}</td>
        <td class="fc-sr-en">${this.esc(w.english)}</td>
        <td class="fc-sr-rat">${ratingLabel}</td>
      </tr>`;
    }).join("");

    this.innerHTML = `
      <div class="fc-wrap">
        <div class="fc-sum">
          <h2 class="fc-sum-title">Session Complete</h2>

          ${isDictation ? `<div class="fc-sum-score">${this.correctCount}/${this.totalAnswered} correct (${scorePct}%)</div>` : ""}

          <div class="fc-sum-badges">
            <span class="fc-sb fc-sb-easy">${easyCount} easy</span>
            <span class="fc-sb fc-sb-hard">${hardCount} hard</span>
            <span class="fc-sb fc-sb-again">${againCount} again</span>
            ${unratedCount > 0 ? `<span class="fc-sb fc-sb-skip">${unratedCount} skip</span>` : ""}
          </div>

          ${totalReviews > 0 ? `<div class="fc-sum-life">${totalReviews} lifetime reviews${streak > 1 ? ` \u00b7 ${streak}-day streak` : ""}</div>` : ""}

          <div class="fc-sum-actions">
            ${hardCards.length > 0 ? `<button class="fc-btn-pri" id="fc-review-hard" type="button">Review ${hardCards.length} Hard</button>` : ""}
            <button class="fc-btn-sec" id="fc-restart" type="button">Restart</button>
            <button class="fc-btn-sec" id="fc-back" type="button">Topics</button>
          </div>

          <div class="fc-sum-table-wrap">
            <table class="fc-sum-table">
              <thead><tr><th>Dutch</th><th>English</th><th>Rating</th></tr></thead>
              <tbody>${summaryRows}</tbody>
            </table>
          </div>
        </div>
      </div>`;

    this.querySelector("#fc-back")!.addEventListener("click", () => this.renderTopicGrid());
    this.querySelector("#fc-restart")!.addEventListener("click", () => this.startPractice());

    const reviewBtn = this.querySelector("#fc-review-hard");
    if (reviewBtn) {
      reviewBtn.addEventListener("click", () => this.startPracticeWithCards(hardCards));
    }
  }
}

customElements.define("flashcard-app", FlashcardApp);
</script>

<style>
  /* ========== Container ========== */
  .fc-wrap {
    max-width: 560px;
    margin: 0 auto;
    font-family: var(--sl-font);
  }

  /* ========== Topic Grid Screen ========== */
  .fc-top-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.25rem;
    flex-wrap: wrap;
  }
  .fc-title {
    font-size: var(--sl-text-h4);
    font-weight: 700;
    margin: 0;
    color: var(--sl-color-white);
    line-height: var(--sl-line-height-headings);
  }
  .fc-stats-pill {
    font-size: var(--sl-text-2xs);
    font-weight: 600;
    color: var(--sl-color-text-accent);
    background: var(--sl-color-accent-low);
    padding: 0.15rem 0.55rem;
    border-radius: 999rem;
  }

  /* Direction pills */
  .fc-dir-bar {
    display: flex;
    gap: 0.3rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
  }
  .fc-dir {
    padding: 0.3rem 0.75rem;
    border-radius: 999rem;
    font-size: var(--sl-text-xs);
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--sl-color-gray-5);
    background: none;
    color: var(--sl-color-white);
    transition: all 0.15s;
  }
  .fc-dir:hover { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); }
  .fc-dir.fc-dir-on { background: var(--sl-color-text-accent); color: var(--sl-color-black); border-color: var(--sl-color-text-accent); }

  /* Topic checkbox list */
  .fc-topic-box {
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    background: var(--sl-color-black);
    margin-bottom: 0.75rem;
    overflow: hidden;
  }
  .fc-topic-all {
    background: var(--sl-color-bg-nav);
    font-weight: 700;
    border-bottom: 1px solid var(--sl-color-gray-5);
  }
  .fc-topic-divider { display: none; }
  .fc-topic-scroll {
    max-height: 250px;
    overflow-y: auto;
    overscroll-behavior: contain;
  }
  .fc-topic-row {
    display: grid;
    grid-template-columns: 20px 1fr auto auto;
    grid-template-rows: auto auto;
    align-items: center;
    gap: 0 0.5rem;
    padding: 0.45rem 0.75rem;
    cursor: pointer;
    transition: background-color 0.1s;
    border-bottom: 1px solid var(--sl-color-gray-6);
    user-select: none;
  }
  .fc-topic-row:last-child { border-bottom: none; }
  .fc-topic-row:hover { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); }
  .fc-topic-row.fc-topic-sel { background-color: var(--sl-color-accent-low); }
  .fc-check {
    width: 16px;
    height: 16px;
    accent-color: var(--sl-color-text-accent);
    cursor: pointer;
    grid-row: 1;
    grid-column: 1;
  }
  .fc-topic-name {
    font-size: var(--sl-text-sm);
    color: var(--sl-color-white);
    grid-row: 1;
    grid-column: 2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .fc-topic-count {
    font-size: var(--sl-text-2xs);
    color: var(--sl-color-gray-3);
    grid-row: 1;
    grid-column: 3;
    text-align: right;
    font-variant-numeric: tabular-nums;
  }
  .fc-topic-pct {
    font-size: var(--sl-text-2xs);
    font-weight: 700;
    color: var(--sl-color-text-accent);
    grid-row: 1;
    grid-column: 4;
    text-align: right;
    min-width: 28px;
    font-variant-numeric: tabular-nums;
  }
  .fc-mastery-bar {
    grid-row: 2;
    grid-column: 2 / -1;
    height: 3px;
    border-radius: 2px;
    background: var(--sl-color-gray-6);
    display: flex;
    overflow: hidden;
    margin-top: 0.2rem;
  }
  .fc-mastery-fill { height: 100%; }
  .fc-mastery-easy { background: #4ade80; }
  .fc-mastery-hard { background: #fbbf24; }
  .fc-mastery-again { background: #f87171; }

  /* Bottom action bar */
  .fc-bottom-bar {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  .fc-fav-filter {
    padding: 0.4rem 0.8rem;
    border-radius: 999rem;
    font-size: var(--sl-text-xs);
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--sl-color-gray-5);
    background: none;
    color: #f87171;
    transition: all 0.15s;
  }
  .fc-fav-filter:hover { background-color: rgba(248, 113, 113, 0.1); }
  .fc-fav-filter.fc-fav-filter-on { background: #fecaca; color: #b91c1c; border-color: #fca5a5; }
  .fc-start {
    flex: 1;
    padding: 0.6rem 1rem;
    border-radius: 999rem;
    font-size: var(--sl-text-sm);
    font-weight: 700;
    cursor: pointer;
    border: 1px solid var(--sl-color-text-accent);
    background: var(--sl-color-text-accent);
    color: var(--sl-color-black);
    transition: opacity 0.15s;
  }
  .fc-start:hover:not(:disabled) { opacity: 0.88; }
  .fc-start:disabled { opacity: 0.35; cursor: not-allowed; }

  /* ========== Card Practice Screen ========== */
  .fc-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.4rem;
  }
  .fc-toolbar-r { display: flex; align-items: center; gap: 0.35rem; }
  .fc-tbtn {
    padding: 0.2rem 0.65rem;
    border-radius: 999rem;
    font-size: var(--sl-text-2xs);
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--sl-color-gray-5);
    background: none;
    color: var(--sl-color-white);
    transition: all 0.15s;
  }
  .fc-tbtn:hover { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); }
  .fc-count {
    font-size: var(--sl-text-2xs);
    color: var(--sl-color-gray-3);
    font-variant-numeric: tabular-nums;
  }
  .fc-score { color: var(--sl-color-text-accent); font-weight: 600; }

  /* Progress bar */
  .fc-pbar {
    width: 100%;
    height: 3px;
    border-radius: 2px;
    background: var(--sl-color-gray-5);
    margin-bottom: 0.75rem;
    overflow: hidden;
  }
  .fc-pfill {
    height: 100%;
    border-radius: 2px;
    background: var(--sl-color-accent);
    transition: width 0.3s ease;
  }

  /* Card row with nav arrows */
  .fc-card-row {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    margin-bottom: 0.3rem;
  }
  .fc-nav {
    flex-shrink: 0;
    width: 36px;
    height: 72px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    line-height: 1;
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.4rem;
    background: none;
    color: var(--sl-color-gray-3);
    cursor: pointer;
    transition: all 0.15s;
    user-select: none;
  }
  .fc-nav:hover:not(.fc-nav-off) { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); color: var(--sl-color-white); }
  .fc-nav-off { opacity: 0.2; cursor: default; }

  /* THE CARD: fixed 280px height */
  .fc-card {
    flex: 1;
    min-width: 0;
    height: 280px;
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    background: var(--sl-color-black);
    box-shadow: var(--sl-shadow-sm);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: border-color 0.2s, background-color 0.2s;
  }
  .fc-card:hover { border-color: var(--sl-color-gray-2); background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); }

  /* Face: fills available space, content centered */
  .fc-face {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 1rem 1.25rem;
    min-height: 0;
    overflow-y: auto;
  }

  /* Bottom: rating buttons pinned to bottom of card */
  .fc-bottom {
    flex-shrink: 0;
    padding: 0 1rem 0.75rem;
    display: flex;
    justify-content: center;
  }

  /* Card content elements */
  .fc-badge {
    display: inline-block;
    font-size: var(--sl-text-2xs);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.1rem 0.4rem;
    border-radius: 0.2rem;
    background: var(--sl-color-gray-5);
    color: var(--sl-color-gray-2);
    margin-bottom: 0.3rem;
  }
  .fc-badge-ans { background: var(--sl-color-accent-low); color: var(--sl-color-accent-high); }
  .fc-word {
    font-size: 1.65rem;
    font-weight: 700;
    color: var(--sl-color-white);
    margin-bottom: 0.15rem;
    line-height: var(--sl-line-height-headings);
  }
  .fc-word-sm {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--sl-color-white);
    margin-bottom: 0.1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
  }
  .fc-ipa {
    font-size: var(--sl-text-xs);
    color: var(--sl-color-gray-3);
    margin-bottom: 0.3rem;
  }
  .fc-divider {
    width: 50px;
    height: 1px;
    background: var(--sl-color-gray-5);
    margin: 0.5rem 0;
  }
  .fc-answer {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--sl-color-text-accent);
    margin-bottom: 0.1rem;
  }

  /* Audio button */
  .fc-audio {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.3rem;
    border: none;
    border-radius: 50%;
    background: none;
    color: var(--sl-color-gray-3);
    cursor: pointer;
    transition: color 0.15s, background-color 0.15s, transform 0.15s;
  }
  .fc-audio:hover { color: var(--sl-color-text-accent); background-color: var(--sl-color-accent-low); transform: scale(1.1); }
  .fc-audio-big { transform: scale(1.8); margin: 0.5rem 0; }
  .fc-audio-big:hover { transform: scale(1.95); }

  /* Listen mode */
  .fc-listen-q { font-size: 2rem; font-weight: 700; color: var(--sl-color-gray-3); margin-top: 0.3rem; }

  /* Dictation */
  .fc-dict-form {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 0.75rem;
    width: 100%;
  }
  .fc-dict-input {
    width: 100%;
    padding: 0.5rem 0.7rem;
    font-size: 1rem;
    font-family: inherit;
    border: 2px solid var(--sl-color-gray-5);
    border-radius: 0.4rem;
    background: var(--sl-color-black);
    color: var(--sl-color-white);
    text-align: center;
    outline: none;
    transition: border-color 0.15s;
    box-sizing: border-box;
  }
  .fc-dict-input:focus { border-color: var(--sl-color-text-accent); }
  .fc-dict-input::placeholder { color: var(--sl-color-gray-3); }
  .fc-dict-check {
    align-self: center;
    padding: 0.35rem 1.2rem;
    border-radius: 999rem;
    font-size: var(--sl-text-xs);
    font-weight: 700;
    cursor: pointer;
    border: 1px solid var(--sl-color-text-accent);
    background: var(--sl-color-text-accent);
    color: var(--sl-color-black);
    transition: opacity 0.15s;
  }
  .fc-dict-check:hover { opacity: 0.88; }
  .fc-dict-result { width: 100%; margin-bottom: 0.25rem; }
  .fc-dict-status { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.25rem; }
  .fc-dict-ok .fc-dict-status { color: #4ade80; }
  .fc-dict-no .fc-dict-status { color: #f87171; }
  .fc-dict-yours { font-size: var(--sl-text-xs); color: #f87171; font-weight: 600; margin-bottom: 0.25rem; text-decoration: line-through; }
  .fc-next-btn {
    padding: 0.35rem 1.2rem;
    border-radius: 999rem;
    font-size: var(--sl-text-xs);
    font-weight: 700;
    cursor: pointer;
    border: 1px solid var(--sl-color-gray-5);
    background: none;
    color: var(--sl-color-white);
    transition: all 0.15s;
  }
  .fc-next-btn:hover { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); }

  /* Hint text */
  .fc-hint {
    font-size: var(--sl-text-xs);
    color: var(--sl-color-gray-3);
    font-style: italic;
  }
  .fc-keys {
    text-align: center;
    font-size: var(--sl-text-2xs);
    color: var(--sl-color-gray-3);
    margin-top: 0.2rem;
  }

  /* Rating buttons inside card */
  .fc-rate-row { display: flex; gap: 0.4rem; }
  .fc-rate {
    padding: 0.3rem 0.9rem;
    border-radius: 999rem;
    font-size: var(--sl-text-xs);
    font-weight: 600;
    cursor: pointer;
    border: 2px solid var(--sl-color-gray-5);
    background: none;
    color: var(--sl-color-white);
    transition: all 0.15s;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
  }
  .fc-rate-key {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.1em;
    height: 1.1em;
    border-radius: 0.15rem;
    background: var(--sl-color-gray-6);
    font-size: 0.7em;
    font-weight: 700;
    color: var(--sl-color-gray-3);
    line-height: 1;
  }
  .fc-rate-again { border-color: #f87171; color: #f87171; }
  .fc-rate-again:hover { background: #f87171; color: var(--sl-color-black); }
  .fc-rate-again:hover .fc-rate-key { background: rgba(0,0,0,0.2); color: var(--sl-color-black); }
  .fc-rate-hard { border-color: #fbbf24; color: #fbbf24; }
  .fc-rate-hard:hover { background: #fbbf24; color: var(--sl-color-black); }
  .fc-rate-hard:hover .fc-rate-key { background: rgba(0,0,0,0.2); color: var(--sl-color-black); }
  .fc-rate-easy { border-color: #4ade80; color: #4ade80; }
  .fc-rate-easy:hover { background: #4ade80; color: var(--sl-color-black); }
  .fc-rate-easy:hover .fc-rate-key { background: rgba(0,0,0,0.2); color: var(--sl-color-black); }

  /* Favorite button */
  .fc-fav-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.25rem;
    border: none;
    border-radius: 50%;
    background: none;
    color: var(--sl-color-gray-3);
    cursor: pointer;
    transition: color 0.15s, transform 0.15s;
  }
  .fc-fav-btn:hover { color: #f87171; transform: scale(1.15); }
  .fc-fav-btn.fc-fav-on { color: #ef4444; }
  .fc-fav-btn.fc-fav-on svg { fill: #ef4444; }

  /* ========== Summary Screen ========== */
  .fc-sum { text-align: center; }
  .fc-sum-title {
    font-size: var(--sl-text-h4);
    font-weight: 700;
    margin: 0 0 0.5rem;
    color: var(--sl-color-white);
    line-height: var(--sl-line-height-headings);
  }
  .fc-sum-score {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--sl-color-text-accent);
    margin-bottom: 0.75rem;
  }
  .fc-sum-badges {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 0.75rem;
  }
  .fc-sb {
    font-size: var(--sl-text-xs);
    font-weight: 700;
    padding: 0.2rem 0.6rem;
    border-radius: 999rem;
  }
  .fc-sb-easy { color: #4ade80; background: rgba(74, 222, 128, 0.12); }
  .fc-sb-hard { color: #fbbf24; background: rgba(251, 191, 36, 0.12); }
  .fc-sb-again { color: #f87171; background: rgba(248, 113, 113, 0.12); }
  .fc-sb-skip { color: var(--sl-color-gray-3); background: var(--sl-color-gray-6); }

  .fc-sum-life {
    font-size: var(--sl-text-xs);
    color: var(--sl-color-gray-3);
    margin-bottom: 0.75rem;
  }

  .fc-sum-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 1rem;
  }
  .fc-btn-pri {
    padding: 0.45rem 1.2rem;
    border-radius: 999rem;
    font-size: var(--sl-text-sm);
    font-weight: 700;
    cursor: pointer;
    border: 1px solid var(--sl-color-text-accent);
    background: var(--sl-color-text-accent);
    color: var(--sl-color-black);
    transition: opacity 0.15s;
  }
  .fc-btn-pri:hover { opacity: 0.88; }
  .fc-btn-sec {
    padding: 0.45rem 1.2rem;
    border-radius: 999rem;
    font-size: var(--sl-text-sm);
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--sl-color-gray-5);
    background: none;
    color: var(--sl-color-white);
    transition: all 0.15s;
  }
  .fc-btn-sec:hover { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); }

  /* Summary word table */
  .fc-sum-table-wrap {
    max-height: 320px;
    overflow-y: auto;
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.4rem;
    text-align: left;
  }
  .fc-sum-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--sl-text-xs);
  }
  .fc-sum-table thead {
    position: sticky;
    top: 0;
    background: var(--sl-color-black);
    z-index: 1;
  }
  .fc-sum-table th {
    padding: 0.35rem 0.5rem;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--sl-color-gray-5);
    color: var(--sl-color-gray-2);
    font-size: var(--sl-text-2xs);
  }
  .fc-sum-table td {
    padding: 0.3rem 0.5rem;
    border-bottom: 1px solid var(--sl-color-gray-6);
  }
  .fc-sr-nl { color: var(--sl-color-white); font-weight: 600; }
  .fc-sr-en { color: var(--sl-color-gray-2); }
  .fc-sr-rat { font-weight: 700; font-size: var(--sl-text-2xs); text-align: center; width: 50px; }
  .fc-sr-easy .fc-sr-rat { color: #4ade80; }
  .fc-sr-hard .fc-sr-rat { color: #fbbf24; }
  .fc-sr-again .fc-sr-rat { color: #f87171; }
  .fc-sr-again { background-color: rgba(248, 113, 113, 0.08); }
  .fc-sr-skip .fc-sr-rat { color: var(--sl-color-gray-3); }

  /* Screen-reader only */
  .sr-only {
    position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
    overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0;
  }

  /* Focus styles */
  .fc-rate:focus-visible, .fc-tbtn:focus-visible, .fc-nav:focus-visible,
  .fc-dir:focus-visible, .fc-start:focus-visible, .fc-audio:focus-visible,
  .fc-fav-btn:focus-visible, .fc-btn-pri:focus-visible, .fc-btn-sec:focus-visible,
  .fc-fav-filter:focus-visible, .fc-next-btn:focus-visible, .fc-dict-check:focus-visible {
    outline: 2px solid var(--sl-color-text-accent);
    outline-offset: 2px;
  }

  /* ========== Mobile ========== */
  @media (max-width: 480px) {
    .fc-word { font-size: 1.35rem; }
    .fc-answer { font-size: 1.1rem; }
    .fc-card { height: 260px; }
    .fc-nav { width: 30px; height: 60px; }
    .fc-keys { display: none; }
    .fc-rate-key { display: none; }
    .fc-topic-name { font-size: var(--sl-text-xs); }
  }
  @media (pointer: coarse) {
    .fc-nav { min-width: 44px; min-height: 44px; }
    .fc-start { min-height: 48px; }
    .fc-dir { min-height: 40px; padding: 0.5rem 0.8rem; }
    .fc-rate { min-height: 44px; padding: 0.45rem 0.9rem; }
    .fc-fav-btn { min-width: 44px; min-height: 44px; }
    .fc-audio { min-width: 44px; min-height: 44px; padding: 8px; }
    .fc-tbtn { min-height: 36px; }
    .fc-rate-key { display: none; }
    .fc-fav-filter { min-height: 40px; }
    .fc-btn-pri, .fc-btn-sec { min-height: 44px; }
    .fc-next-btn { min-height: 44px; }
    .fc-dict-check { min-height: 44px; }
  }
</style>
