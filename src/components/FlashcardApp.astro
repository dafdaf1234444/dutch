---
// FlashcardApp â€“ Dutch vocabulary flashcard practice.
// Five modes (Dutch->English, English->Dutch, Mixed, Listen, Dictation),
// spaced repetition, session tracking with end-of-session summary,
// review hard words, keyboard shortcuts, favorites, reshuffling.
---

<flashcard-app id="flashcard-app"></flashcard-app>

<script>
import { speakDutch } from "../scripts/dutch-speech";
import { DECKS, type Word } from "../data/flashcard-decks";

/* Standalone audio handler for flashcard audio buttons */
document.addEventListener("click", (e) => {
  const btn = (e.target as Element).closest?.(".dutch-audio-btn") as HTMLButtonElement | null;
  if (!btn) return;
  const text = btn.dataset.text;
  if (!text) return;
  speakDutch(text, btn);
});
const TOPICS = DECKS;
const FC_STORAGE_KEY = "dutch-fc-progress";

type Direction = "nl-en" | "en-nl" | "mixed" | "listen" | "dictation";

interface CardProgress {
  ease: number;      // 0=new, 1=again, 2=hard, 3=easy
  lastSeen: number;  // timestamp
  reviews: number;
  favorite: boolean;
}

interface FCStorage {
  cards: Record<string, CardProgress>;
  stats: { totalReviews: number; lastDate: string; streak: number };
}

class FlashcardApp extends HTMLElement {
  selectedTopics: Set<number> = new Set();
  cards: Word[] = [];
  order: number[] = [];
  current = 0;
  flipped = false;
  direction: Direction = "mixed";
  /* per-card: true = show Dutch first, false = show English first */
  showDutchFirst: boolean[] = [];
  /* dictation scoring */
  correctCount = 0;
  totalAnswered = 0;
  /* progress & favorites */
  showFavoritesOnly = false;
  private storage: FCStorage = { cards: {}, stats: { totalReviews: 0, lastDate: "", streak: 0 } };
  /* session tracking: maps order index -> ease rating (1=again, 2=hard, 3=easy) */
  private sessionRatings: Map<number, number> = new Map();

  static SVG = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
  static HEART = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;

  private _keyHandler: ((e: KeyboardEvent) => void) | null = null;

  connectedCallback() {
    this.loadStorage();
    this.renderTopicGrid();
  }

  /* ---- Storage helpers ---- */

  private loadStorage(): void {
    try {
      const raw = localStorage.getItem(FC_STORAGE_KEY);
      if (raw) this.storage = JSON.parse(raw);
    } catch { /* localStorage unavailable */ }
  }

  private saveStorage(): void {
    try {
      localStorage.setItem(FC_STORAGE_KEY, JSON.stringify(this.storage));
    } catch { /* localStorage unavailable */ }
  }

  private cardKey(card: Word): string {
    return card.dutch.toLowerCase();
  }

  private getProgress(card: Word): CardProgress {
    return this.storage.cards[this.cardKey(card)] ?? { ease: 0, lastSeen: 0, reviews: 0, favorite: false };
  }

  private rateCard(card: Word, ease: number): void {
    const key = this.cardKey(card);
    const prev = this.storage.cards[key] ?? { ease: 0, lastSeen: 0, reviews: 0, favorite: false };
    this.storage.cards[key] = { ...prev, ease, lastSeen: Date.now(), reviews: prev.reviews + 1 };
    this.storage.stats.totalReviews++;
    const today = new Date().toISOString().slice(0, 10);
    const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
    if (this.storage.stats.lastDate !== today) {
      this.storage.stats.streak = this.storage.stats.lastDate === yesterday ? this.storage.stats.streak + 1 : 1;
      this.storage.stats.lastDate = today;
    }
    this.saveStorage();
  }

  private toggleFavorite(card: Word): void {
    const key = this.cardKey(card);
    const prev = this.storage.cards[key] ?? { ease: 0, lastSeen: 0, reviews: 0, favorite: false };
    this.storage.cards[key] = { ...prev, favorite: !prev.favorite };
    this.saveStorage();
  }

  private isFavorite(card: Word): boolean {
    return this.getProgress(card).favorite;
  }

  private getFavoritesCount(): number {
    return Object.values(this.storage.cards).filter(c => c.favorite).length;
  }

  private getTopicMastery(topicIndex: number): { total: number; easy: number; hard: number; again: number; unseen: number } {
    const words = TOPICS[topicIndex].words;
    let easy = 0, hard = 0, again = 0, unseen = 0;
    for (const w of words) {
      const p = this.getProgress(w);
      if (p.ease === 3) easy++;
      else if (p.ease === 2) hard++;
      else if (p.ease === 1) again++;
      else unseen++;
    }
    return { total: words.length, easy, hard, again, unseen };
  }

  shuffle<T>(arr: T[]): T[] {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  esc(s: string): string {
    return s.replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  }

  bindKeys() {
    this.unbindKeys();
    this._keyHandler = (e: KeyboardEvent) => {
      if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) return;
      if (e.key === " " || e.key === "Enter") {
        e.preventDefault();
        this.advance();
      } else if (e.key === "ArrowRight") {
        e.preventDefault();
        if (this.flipped) { this.current++; this.flipped = false; this.renderCard(); }
      } else if (e.key === "ArrowLeft") {
        e.preventDefault();
        if (this.current > 0) { this.current--; this.flipped = false; this.renderCard(); }
      } else if (this.flipped && (e.key === "1" || e.key === "2" || e.key === "3")) {
        e.preventDefault();
        const card = this.cards[this.order[this.current]];
        const ease = Number(e.key);
        this.rateCard(card, ease);
        this.sessionRatings.set(this.current, ease);
        this.current++;
        this.flipped = false;
        this.renderCard();
      }
    };
    document.addEventListener("keydown", this._keyHandler);
  }

  unbindKeys() {
    if (this._keyHandler) {
      document.removeEventListener("keydown", this._keyHandler);
      this._keyHandler = null;
    }
  }

  advance() {
    if (this.direction === "dictation") {
      if (!this.flipped) {
        this.submitDictation();
      } else {
        this.current++;
        this.flipped = false;
        this.renderCard();
      }
      return;
    }
    if (!this.flipped) {
      this.flipped = true;
      /* Auto-play Dutch audio when revealing Dutch side */
      const card = this.cards[this.order[this.current]];
      if (!this.showDutchFirst[this.current]) {
        speakDutch(card.dutch);
      }
      this.renderCard();
    } else {
      this.current++;
      this.flipped = false;
      this.renderCard();
    }
  }

  /* ---- topic selection screen ---- */

  renderTopicGrid() {
    this.unbindKeys();
    const totalSelected = [...this.selectedTopics].reduce(
      (sum, i) => sum + TOPICS[i].words.length, 0
    );

    const dirLabels: Record<Direction, string> = {
      "nl-en": "Dutch \u2192 English",
      "en-nl": "English \u2192 Dutch",
      "mixed": "Mixed",
      "listen": "Listen",
      "dictation": "Dictation",
    };

    const { totalReviews, streak } = this.storage.stats;
    const favCount = this.getFavoritesCount();
    const statsLine = totalReviews > 0
      ? `${totalReviews} reviews${streak > 1 ? ` \u00b7 ${streak}-day streak` : ""}`
      : "";

    this.innerHTML = `
      <div class="fc-container">
        <div class="fc-grid-header">
          <h2 class="fc-heading">Flashcards</h2>
          ${statsLine ? `<span class="fc-stats-badge">${statsLine}</span>` : ""}
        </div>
        <p class="fc-subheading">Select topics, pick a mode, then start practicing.</p>

        <div class="fc-topic-grid">
          ${TOPICS.map((t, i) => {
            const m = this.getTopicMastery(i);
            const masteryPct = m.total > 0 ? Math.round(((m.easy + m.hard) / m.total) * 100) : 0;
            const sel = this.selectedTopics.has(i);
            return `
            <button class="fc-topic-card ${sel ? "fc-topic-selected" : ""}"
                    data-index="${i}" type="button">
              <span class="fc-topic-check">${sel ? "&#10003;" : ""}</span>
              <span class="fc-topic-name">${t.name}</span>
              <span class="fc-topic-meta">
                <span class="fc-topic-count">${t.words.length} words</span>
                ${masteryPct > 0 ? `<span class="fc-topic-mastery" title="${m.easy} easy, ${m.hard} hard, ${m.again} again, ${m.unseen} unseen">${masteryPct}%</span>` : ""}
              </span>
              ${masteryPct > 0 ? `<div class="fc-mastery-bar"><div class="fc-mastery-easy" style="width:${Math.round((m.easy / m.total) * 100)}%"></div><div class="fc-mastery-hard" style="width:${Math.round((m.hard / m.total) * 100)}%"></div><div class="fc-mastery-again" style="width:${Math.round((m.again / m.total) * 100)}%"></div></div>` : ""}
            </button>`;
          }).join("")}
        </div>

        <div class="fc-direction">
          ${(["nl-en", "en-nl", "mixed", "listen", "dictation"] as Direction[]).map(d => `
            <button class="fc-dir-btn ${this.direction === d ? "fc-dir-active" : ""}"
                    data-dir="${d}" type="button">${dirLabels[d]}</button>
          `).join("")}
        </div>

        <div class="fc-actions">
          <button class="fc-btn fc-btn-secondary" id="fc-select-all" type="button">
            ${this.selectedTopics.size === TOPICS.length ? "Deselect All" : "Select All"}
          </button>
          ${favCount > 0 ? `<button class="fc-btn fc-btn-secondary ${this.showFavoritesOnly ? "fc-fav-active" : ""}" id="fc-fav-filter" type="button">&#9829; Favorites (${favCount})</button>` : ""}
          <button class="fc-btn fc-btn-primary" id="fc-start" type="button"
                  ${totalSelected === 0 ? "disabled" : ""}>
            Start (${totalSelected} cards)
          </button>
        </div>
      </div>`;

    this.querySelectorAll<HTMLButtonElement>(".fc-topic-card").forEach((btn) => {
      btn.addEventListener("click", () => {
        const idx = Number(btn.dataset.index);
        this.selectedTopics.has(idx) ? this.selectedTopics.delete(idx) : this.selectedTopics.add(idx);
        this.renderTopicGrid();
      });
    });

    this.querySelectorAll<HTMLButtonElement>(".fc-dir-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        this.direction = btn.dataset.dir as Direction;
        this.renderTopicGrid();
      });
    });

    this.querySelector("#fc-select-all")!.addEventListener("click", () => {
      if (this.selectedTopics.size === TOPICS.length) this.selectedTopics.clear();
      else TOPICS.forEach((_, i) => this.selectedTopics.add(i));
      this.renderTopicGrid();
    });

    const favFilterBtn = this.querySelector("#fc-fav-filter");
    if (favFilterBtn) {
      favFilterBtn.addEventListener("click", () => {
        this.showFavoritesOnly = !this.showFavoritesOnly;
        this.renderTopicGrid();
      });
    }

    this.querySelector("#fc-start")!.addEventListener("click", () => {
      if (totalSelected > 0) this.startPractice();
    });
  }

  startPractice() {
    this.cards = [];
    for (const i of this.selectedTopics) this.cards.push(...TOPICS[i].words);
    if (this.showFavoritesOnly) {
      this.cards = this.cards.filter(c => this.isFavorite(c));
    }
    if (this.cards.length === 0) return;

    // Spaced repetition: prioritize unseen and difficult cards
    const indices = [...Array(this.cards.length).keys()];
    this.shuffle(indices);
    indices.sort((a, b) => {
      const pa = this.getProgress(this.cards[a]);
      const pb = this.getProgress(this.cards[b]);
      // Unseen (ease=0) first, then again (1), hard (2), easy (3)
      if (pa.ease !== pb.ease) return pa.ease - pb.ease;
      // Within same ease, older reviews first
      return pa.lastSeen - pb.lastSeen;
    });
    this.order = indices;

    this.showDutchFirst = this.order.map(() => {
      if (this.direction === "nl-en" || this.direction === "listen" || this.direction === "dictation") return true;
      if (this.direction === "en-nl") return false;
      return Math.random() < 0.5;
    });
    this.current = 0;
    this.flipped = false;
    this.correctCount = 0;
    this.totalAnswered = 0;
    this.sessionRatings = new Map();
    this.bindKeys();
    this.renderCard();
  }

  startPracticeWithCards(cardIndices: number[]) {
    // Start practice with specific card indices (for "Review Hard Words")
    this.order = this.shuffle([...cardIndices]);
    this.showDutchFirst = this.order.map(() => {
      if (this.direction === "nl-en" || this.direction === "listen" || this.direction === "dictation") return true;
      if (this.direction === "en-nl") return false;
      return Math.random() < 0.5;
    });
    this.current = 0;
    this.flipped = false;
    this.correctCount = 0;
    this.totalAnswered = 0;
    this.sessionRatings = new Map();
    this.bindKeys();
    this.renderCard();
  }

  reshuffle() {
    this.order = this.shuffle([...Array(this.cards.length).keys()]);
    this.showDutchFirst = this.order.map(() => {
      if (this.direction === "nl-en" || this.direction === "listen" || this.direction === "dictation") return true;
      if (this.direction === "en-nl") return false;
      return Math.random() < 0.5;
    });
    this.current = 0;
    this.flipped = false;
    // Preserve correctCount and totalAnswered so reshuffle doesn't erase progress
    this.renderCard();
  }

  checkAnswer(input: string, correct: string): boolean {
    const normalize = (s: string) =>
      s.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
       .toLowerCase().trim().replace(/[?!.,;:'"]/g, "");
    return normalize(input) === normalize(correct);
  }

  submitDictation() {
    if (this.flipped) return;
    const input = this.querySelector<HTMLInputElement>(".fc-dictation-input");
    if (!input) return;
    const userAnswer = input.value;
    const card = this.cards[this.order[this.current]];
    const isCorrect = this.checkAnswer(userAnswer, card.dutch);
    this.totalAnswered++;
    if (isCorrect) {
      this.correctCount++;
      this.sessionRatings.set(this.current, 3); // auto-rate correct as easy
      this.rateCard(card, 3);
    } else {
      this.sessionRatings.set(this.current, 1); // auto-rate incorrect as again
      this.rateCard(card, 1);
    }
    this.flipped = true;
    this.renderCard(userAnswer);
  }

  renderCard(dictationAnswer?: string) {
    const total = this.order.length;

    if (this.current >= total) {
      this.renderSummary();
      return;
    }

    const card = this.cards[this.order[this.current]];
    const dutch = this.showDutchFirst[this.current];
    const isListen = this.direction === "listen";
    const isDictation = this.direction === "dictation";
    const num = this.current + 1;
    const pct = Math.round((this.current / total) * 100);

    let cardInner: string;

    if (isDictation && !this.flipped) {
      cardInner = `
        <div class="fc-card-inner">
          <div class="fc-lang-badge">DICTATION</div>
          <button class="dutch-audio-btn fc-audio-btn fc-listen-btn" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${FlashcardApp.SVG}</button>
          <div class="fc-dictation-form">
            <label for="fc-dictation-field" class="sr-only">Type what you hear</label>
            <input type="text" id="fc-dictation-field" class="fc-dictation-input" placeholder="Type what you hear..." autocomplete="off" autocapitalize="off" spellcheck="false" />
            <button class="fc-btn fc-btn-primary fc-dictation-check" type="button">Check</button>
          </div>
        </div>`;
    } else if (isDictation && this.flipped) {
      const userAnswer = dictationAnswer ?? "";
      const isCorrect = this.checkAnswer(userAnswer, card.dutch);
      cardInner = `
        <div class="fc-card-inner">
          <div class="fc-dictation-result ${isCorrect ? "fc-dictation-correct" : "fc-dictation-wrong"}">
            <div class="fc-dictation-status">${isCorrect ? "&#10003; Correct!" : "&#10007; Incorrect"}</div>
            ${!isCorrect ? `<div class="fc-dictation-your">Your answer: <span class="fc-dictation-diff">${this.esc(userAnswer) || "(empty)"}</span></div>` : ""}
            <div class="fc-dictation-answer">
              <span>${this.esc(card.dutch)}</span>
              <button class="dutch-audio-btn fc-audio-btn" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${FlashcardApp.SVG}</button>
            </div>
            ${card.ipa ? `<div class="fc-ipa">${this.esc(card.ipa)}</div>` : ""}
            <div class="fc-divider"></div>
            <div class="fc-lang-badge fc-lang-badge-answer">EN</div>
            <div class="fc-answer">${this.esc(card.english)}</div>
          </div>
        </div>`;
    } else if (isListen && !this.flipped) {
      cardInner = `
        <div class="fc-card-inner">
          <div class="fc-lang-badge">LISTEN</div>
          <button class="dutch-audio-btn fc-audio-btn fc-listen-btn" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${FlashcardApp.SVG}</button>
          <div class="fc-listen-hint">?</div>
        </div>`;
    } else if (isListen && this.flipped) {
      cardInner = `
        <div class="fc-card-inner">
          <div class="fc-lang-badge">NL</div>
          <div class="fc-word">${this.esc(card.dutch)}</div>
          ${card.ipa ? `<div class="fc-ipa">${this.esc(card.ipa)}</div>` : ""}
          <button class="dutch-audio-btn fc-audio-btn" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${FlashcardApp.SVG}</button>
          <div class="fc-divider"></div>
          <div class="fc-lang-badge fc-lang-badge-answer">EN</div>
          <div class="fc-answer">${this.esc(card.english)}</div>
        </div>`;
    } else {
      // Normal modes
      const frontWord = dutch ? card.dutch : card.english;
      const frontSub = dutch && card.ipa ? `<div class="fc-ipa">${this.esc(card.ipa)}</div>` : "";
      const frontAudio = dutch
        ? `<button class="dutch-audio-btn fc-audio-btn" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${FlashcardApp.SVG}</button>`
        : "";
      const frontLabel = dutch ? "NL" : "EN";

      const backWord = dutch ? card.english : card.dutch;
      const backSub = !dutch && card.ipa ? `<div class="fc-ipa">${this.esc(card.ipa)}</div>` : "";
      const backAudio = !dutch
        ? `<button class="dutch-audio-btn fc-audio-btn" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${FlashcardApp.SVG}</button>`
        : "";
      const backLabel = dutch ? "EN" : "NL";

      cardInner = `
        <div class="fc-card-inner">
          <div class="fc-lang-badge">${frontLabel}</div>
          <div class="fc-word">${this.esc(frontWord)}</div>
          ${frontSub}
          ${frontAudio}
          ${this.flipped ? `
            <div class="fc-divider"></div>
            <div class="fc-lang-badge fc-lang-badge-answer">${backLabel}</div>
            <div class="fc-answer">${this.esc(backWord)}</div>
            ${backSub}
            ${backAudio}
          ` : ""}
        </div>`;
    }

    const fav = this.isFavorite(card);

    this.innerHTML = `
      <div class="fc-container">
        <div class="fc-toolbar">
          <button class="fc-btn fc-btn-small fc-btn-secondary" id="fc-back" type="button">Back</button>
          <span class="fc-counter">${isDictation && this.totalAnswered > 0 ? `<span class="fc-score" aria-live="polite">${this.correctCount}/${this.totalAnswered}</span> \u00b7 ` : ""}${num} / ${total}</span>
          <div class="fc-toolbar-right">
            <button class="fc-fav-btn ${fav ? "fc-fav-on" : ""}" id="fc-fav" type="button" title="${fav ? "Remove from favorites" : "Add to favorites"}" aria-label="${fav ? "Remove from favorites" : "Add to favorites"}">${FlashcardApp.HEART}</button>
            <button class="fc-btn fc-btn-small fc-btn-secondary" id="fc-reshuffle" type="button" title="Reshuffle cards">Shuffle</button>
          </div>
        </div>
        <div class="fc-progress-bar" role="progressbar" aria-valuenow="${pct}" aria-valuemin="0" aria-valuemax="100"><div class="fc-progress-fill" style="width:${pct}%"></div></div>

        <div class="fc-card-row">
          <button class="fc-nav fc-nav-prev ${this.current === 0 ? "fc-nav-disabled" : ""}" id="fc-prev" type="button" title="Previous card" aria-label="Previous card">&#8249;</button>
          <div class="fc-card" id="fc-card">
            ${cardInner}
          </div>
          <button class="fc-nav fc-nav-next" id="fc-next" type="button" title="${this.flipped ? "Next card" : "Show Answer"}" aria-label="Next">&#8250;</button>
        </div>

        ${this.flipped ? `
        <div class="fc-rating" aria-label="Rate difficulty">
          <button class="fc-rate-btn fc-rate-again" data-ease="1" type="button"><span class="fc-rate-key">1</span> Again</button>
          <button class="fc-rate-btn fc-rate-hard" data-ease="2" type="button"><span class="fc-rate-key">2</span> Hard</button>
          <button class="fc-rate-btn fc-rate-easy" data-ease="3" type="button"><span class="fc-rate-key">3</span> Easy</button>
        </div>` : `
        <div class="fc-tap-hint">Tap card or press Space to reveal</div>`}

        <div class="fc-shortcut-hint">&larr; Prev &nbsp; Space / Enter &nbsp; Next &rarr; &nbsp; ${this.flipped ? "1-2-3 Rate" : ""}</div>
      </div>`;

    this.querySelector("#fc-next")!.addEventListener("click", () => this.advance());
    this.querySelector("#fc-prev")!.addEventListener("click", () => {
      if (this.current > 0) { this.current--; this.flipped = false; this.renderCard(); }
    });
    this.querySelector("#fc-card")!.addEventListener("click", (e) => {
      if ((e.target as Element).closest(".dutch-audio-btn")) return;
      if ((e.target as Element).closest(".fc-dictation-form")) return;
      if (isDictation && !this.flipped) return;
      this.advance();
    });
    this.querySelector("#fc-back")!.addEventListener("click", () => { this.unbindKeys(); this.renderTopicGrid(); });
    this.querySelector("#fc-reshuffle")!.addEventListener("click", () => this.reshuffle());
    this.querySelector("#fc-fav")!.addEventListener("click", () => {
      this.toggleFavorite(card);
      this.renderCard();
    });
    this.querySelectorAll<HTMLButtonElement>(".fc-rate-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const ease = Number(btn.dataset.ease);
        this.rateCard(card, ease);
        this.sessionRatings.set(this.current, ease);
        this.current++;
        this.flipped = false;
        this.renderCard();
      });
    });

    // Dictation mode: wire up check button and Enter key on input
    if (isDictation && !this.flipped) {
      const checkBtn = this.querySelector(".fc-dictation-check");
      if (checkBtn) checkBtn.addEventListener("click", () => this.submitDictation());
      const input = this.querySelector<HTMLInputElement>(".fc-dictation-input");
      if (input) {
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") { e.preventDefault(); this.submitDictation(); }
        });
        requestAnimationFrame(() => input.focus());
      }
    }

    // Auto-play in Listen and Dictation mode
    if ((isListen || isDictation) && !this.flipped) {
      setTimeout(() => speakDutch(card.dutch), 150);
    }
  }

  renderSummary() {
    this.unbindKeys();
    const total = this.order.length;
    const isDictation = this.direction === "dictation";

    // Count session ratings
    let easyCount = 0, hardCount = 0, againCount = 0, unratedCount = 0;
    for (let i = 0; i < total; i++) {
      const rating = this.sessionRatings.get(i);
      if (rating === 3) easyCount++;
      else if (rating === 2) hardCount++;
      else if (rating === 1) againCount++;
      else unratedCount++;
    }

    // Collect hard/again cards for review
    const hardCards: number[] = [];
    for (let i = 0; i < total; i++) {
      const rating = this.sessionRatings.get(i);
      if (rating === 1 || rating === 2) {
        hardCards.push(this.order[i]);
      }
    }

    const { totalReviews, streak } = this.storage.stats;
    const scorePct = isDictation && this.totalAnswered > 0 ? Math.round((this.correctCount / this.totalAnswered) * 100) : 0;

    // Build summary word list
    const summaryRows = this.order.map((idx, pos) => {
      const w = this.cards[idx];
      const rating = this.sessionRatings.get(pos);
      let ratingLabel = "";
      let ratingClass = "";
      if (rating === 3) { ratingLabel = "Easy"; ratingClass = "fc-sum-easy"; }
      else if (rating === 2) { ratingLabel = "Hard"; ratingClass = "fc-sum-hard"; }
      else if (rating === 1) { ratingLabel = "Again"; ratingClass = "fc-sum-again"; }
      else { ratingLabel = "\u2014"; ratingClass = "fc-sum-skip"; }
      return `<tr class="${ratingClass}">
        <td class="fc-sum-nl">${this.esc(w.dutch)}</td>
        <td class="fc-sum-en">${this.esc(w.english)}</td>
        <td class="fc-sum-rating">${ratingLabel}</td>
      </tr>`;
    }).join("");

    this.innerHTML = `
      <div class="fc-container">
        <div class="fc-summary">
          <h2 class="fc-heading">Session Complete</h2>
          <p class="fc-subheading">You reviewed ${total} cards.</p>

          ${isDictation ? `<div class="fc-score-final">${this.correctCount} / ${this.totalAnswered} correct (${scorePct}%)</div>` : ""}

          <div class="fc-summary-stats">
            <div class="fc-stat fc-stat-easy"><span class="fc-stat-num">${easyCount}</span><span class="fc-stat-label">Easy</span></div>
            <div class="fc-stat fc-stat-hard"><span class="fc-stat-num">${hardCount}</span><span class="fc-stat-label">Hard</span></div>
            <div class="fc-stat fc-stat-again"><span class="fc-stat-num">${againCount}</span><span class="fc-stat-label">Again</span></div>
            ${unratedCount > 0 ? `<div class="fc-stat fc-stat-skip"><span class="fc-stat-num">${unratedCount}</span><span class="fc-stat-label">Skipped</span></div>` : ""}
          </div>

          ${totalReviews > 0 ? `<div class="fc-lifetime-stats">${totalReviews} lifetime reviews${streak > 1 ? ` \u00b7 ${streak}-day streak` : ""}</div>` : ""}

          <div class="fc-summary-actions">
            ${hardCards.length > 0 ? `<button class="fc-btn fc-btn-primary" id="fc-review-hard" type="button">Review ${hardCards.length} Hard Words</button>` : ""}
            <button class="fc-btn fc-btn-secondary" id="fc-restart" type="button">Restart All</button>
            <button class="fc-btn fc-btn-secondary" id="fc-back" type="button">Back to Topics</button>
          </div>

          <details class="fc-summary-details" open>
            <summary class="fc-sum-toggle">All Words</summary>
            <div class="fc-summary-table-wrap">
              <table class="fc-summary-table">
                <thead><tr><th>Dutch</th><th>English</th><th>Rating</th></tr></thead>
                <tbody>${summaryRows}</tbody>
              </table>
            </div>
          </details>
        </div>
      </div>`;

    this.querySelector("#fc-back")!.addEventListener("click", () => this.renderTopicGrid());
    this.querySelector("#fc-restart")!.addEventListener("click", () => this.startPractice());

    const reviewBtn = this.querySelector("#fc-review-hard");
    if (reviewBtn) {
      reviewBtn.addEventListener("click", () => this.startPracticeWithCards(hardCards));
    }
  }
}

customElements.define("flashcard-app", FlashcardApp);
</script>

<style>
  .fc-container { max-width: 640px; margin: 0 auto; }
  .fc-center { text-align: center; }
  .fc-heading { font-size: var(--sl-text-h4); font-weight: 700; margin: 0 0 0.25rem; color: var(--sl-color-white); line-height: var(--sl-line-height-headings); }
  .fc-subheading { margin: 0 0 1.25rem; color: var(--sl-color-gray-3); font-size: var(--sl-text-sm); }

  /* grid header with stats badge */
  .fc-grid-header { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
  .fc-stats-badge {
    font-size: var(--sl-text-2xs); font-weight: 600; color: var(--sl-color-text-accent);
    background: var(--sl-color-accent-low); padding: 0.2rem 0.6rem; border-radius: 999rem;
  }

  /* topic grid */
  .fc-topic-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 0.65rem; margin-bottom: 1rem;
  }
  .fc-topic-card {
    position: relative; display: flex; flex-direction: column; align-items: flex-start;
    gap: 0.15rem; padding: 0.75rem 0.85rem; border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem; background: var(--sl-color-black); cursor: pointer; text-align: left;
    color: var(--sl-color-white); box-shadow: var(--sl-shadow-sm);
    transition: border-color 0.15s, background-color 0.15s;
  }
  .fc-topic-card:hover { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); }
  .fc-topic-card.fc-topic-selected { border-color: var(--sl-color-accent); background-color: var(--sl-color-accent-low); }
  .fc-topic-check { position: absolute; top: 0.45rem; right: 0.6rem; font-size: var(--sl-text-sm); font-weight: 700; color: var(--sl-color-accent-high); line-height: 1; }
  .fc-topic-name { font-weight: 600; font-size: var(--sl-text-sm); line-height: 1.25; }
  .fc-topic-meta { display: flex; align-items: center; gap: 0.5rem; width: 100%; }
  .fc-topic-count { font-size: var(--sl-text-xs); color: var(--sl-color-gray-3); }
  .fc-topic-mastery { font-size: var(--sl-text-2xs); font-weight: 700; color: var(--sl-color-text-accent); margin-left: auto; }

  /* mastery bar on topic cards */
  .fc-mastery-bar { width: 100%; height: 3px; border-radius: 2px; background: var(--sl-color-gray-6); display: flex; overflow: hidden; margin-top: 0.3rem; }
  .fc-mastery-easy { background: #4ade80; }
  .fc-mastery-hard { background: #fbbf24; }
  .fc-mastery-again { background: #f87171; }

  /* direction picker */
  .fc-direction { display: flex; gap: 0.4rem; justify-content: center; margin-bottom: 1.25rem; flex-wrap: wrap; }
  .fc-dir-btn {
    padding: 0.4rem 0.9rem; border-radius: 999rem; font-size: var(--sl-text-xs); font-weight: 600;
    cursor: pointer; border: 1px solid var(--sl-color-gray-5); background: none;
    color: var(--sl-color-white); transition: all 0.15s;
  }
  .fc-dir-btn:hover { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); }
  .fc-dir-btn.fc-dir-active { background: var(--sl-color-text-accent); color: var(--sl-color-black); border-color: var(--sl-color-text-accent); }

  /* actions */
  .fc-actions { display: flex; gap: 0.65rem; justify-content: center; flex-wrap: wrap; }

  /* buttons */
  .fc-btn {
    padding: 0.55rem 1.4rem; border-radius: 999rem; font-size: var(--sl-text-sm); font-weight: 600;
    cursor: pointer; border: 1px solid var(--sl-color-gray-5); background: none;
    color: var(--sl-color-white); transition: background-color 0.15s, opacity 0.15s;
  }
  .fc-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .fc-btn-primary { background: var(--sl-color-text-accent); color: var(--sl-color-black); border-color: var(--sl-color-text-accent); }
  .fc-btn-primary:hover:not(:disabled) { opacity: 0.88; }
  .fc-btn-secondary:hover:not(:disabled) { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); }
  .fc-btn-small { padding: 0.3rem 0.85rem; font-size: var(--sl-text-xs); }

  /* toolbar */
  .fc-toolbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
  .fc-counter { font-size: var(--sl-text-xs); color: var(--sl-color-gray-3); font-variant-numeric: tabular-nums; }

  /* progress */
  .fc-progress-bar { width: 100%; height: 4px; border-radius: 2px; background: var(--sl-color-gray-5); margin-bottom: 1.25rem; overflow: hidden; }
  .fc-progress-fill { height: 100%; border-radius: 2px; background: var(--sl-color-accent); transition: width 0.3s ease; }

  /* card row with nav arrows */
  .fc-card-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; }
  .fc-nav {
    flex-shrink: 0; width: 40px; height: 80px; display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem; line-height: 1; border: 1px solid var(--sl-color-gray-5); border-radius: 0.5rem;
    background: none; color: var(--sl-color-gray-3); cursor: pointer; transition: all 0.15s;
    user-select: none;
  }
  .fc-nav:hover:not(.fc-nav-disabled) { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); color: var(--sl-color-white); }
  .fc-nav-disabled { opacity: 0.2; cursor: default; }

  /* card */
  .fc-card {
    flex: 1; min-width: 0;
    border: 1px solid var(--sl-color-gray-5); border-radius: 0.5rem;
    padding: 2rem 1.5rem; min-height: 220px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    text-align: center; background: var(--sl-color-black);
    box-shadow: var(--sl-shadow-sm); transition: border-color 0.2s, background-color 0.2s;
  }
  .fc-card:hover { border-color: var(--sl-color-gray-2); background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); }
  .fc-card-inner { width: 100%; }
  .fc-lang-badge {
    display: inline-block; font-size: var(--sl-text-2xs); font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.05em; padding: 0.15rem 0.5rem; border-radius: 0.25rem;
    background: var(--sl-color-gray-5); color: var(--sl-color-gray-2); margin-bottom: 0.5rem;
  }
  .fc-lang-badge-answer { background: var(--sl-color-accent-low); color: var(--sl-color-accent-high); }
  .fc-word { font-size: 1.75rem; font-weight: 700; color: var(--sl-color-white); margin-bottom: 0.3rem; line-height: var(--sl-line-height-headings); }
  .fc-ipa { font-size: var(--sl-text-sm); color: var(--sl-color-gray-3); margin-bottom: 0.5rem; }
  .fc-audio-btn {
    display: inline-flex; align-items: center; justify-content: center; padding: 0.4rem;
    border: 1px solid var(--sl-color-gray-5); border-radius: 0.25rem; background: none;
    color: var(--sl-color-text-accent); cursor: pointer; transition: background-color 0.15s;
  }
  .fc-audio-btn:hover { background-color: var(--sl-color-accent-low); }
  .fc-divider { width: 60px; height: 1px; background: var(--sl-color-gray-5); margin: 1rem auto; }
  .fc-answer { font-size: 1.4rem; font-weight: 600; color: var(--sl-color-text-accent); margin-bottom: 0.2rem; }

  /* tap hint (shown when card is not flipped) */
  .fc-tap-hint { text-align: center; font-size: var(--sl-text-xs); color: var(--sl-color-gray-3); margin-bottom: 0.5rem; font-style: italic; }

  .fc-shortcut-hint { text-align: center; font-size: var(--sl-text-2xs); color: var(--sl-color-gray-3); margin-bottom: 1rem; }

  /* listen mode */
  .fc-listen-btn { transform: scale(2); margin: 1rem 0; }
  .fc-listen-hint { font-size: 2.5rem; font-weight: 700; color: var(--sl-color-gray-3); margin-top: 0.75rem; }

  /* dictation mode */
  .fc-dictation-form { display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1rem; width: 100%; }
  .fc-dictation-input {
    width: 100%; padding: 0.65rem 0.85rem; font-size: 1.1rem; font-family: inherit;
    border: 2px solid var(--sl-color-gray-5); border-radius: 0.5rem;
    background: var(--sl-color-black); color: var(--sl-color-white);
    text-align: center; outline: none; transition: border-color 0.15s;
    box-sizing: border-box;
  }
  .fc-dictation-input:focus { border-color: var(--sl-color-text-accent); }
  .fc-dictation-input::placeholder { color: var(--sl-color-gray-3); }
  .fc-dictation-check { align-self: center; }
  .fc-dictation-result { width: 100%; }
  .fc-dictation-status { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.75rem; }
  .fc-dictation-correct .fc-dictation-status { color: #4ade80; }
  .fc-dictation-wrong .fc-dictation-status { color: #f87171; }
  .fc-dictation-your { font-size: var(--sl-text-sm); color: var(--sl-color-gray-3); margin-bottom: 0.5rem; }
  .fc-dictation-diff { color: #f87171; font-weight: 600; }
  .fc-dictation-answer { font-size: 1.4rem; font-weight: 700; color: var(--sl-color-white); margin-bottom: 0.25rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
  .fc-score { color: var(--sl-color-text-accent); font-weight: 600; }
  .fc-score-final { font-size: 1.25rem; font-weight: 700; color: var(--sl-color-text-accent); margin-bottom: 1.25rem; }

  /* focus styles */
  .fc-btn:focus-visible, .fc-nav:focus-visible, .fc-dir-btn:focus-visible,
  .fc-topic-card:focus-visible, .fc-audio-btn:focus-visible, .fc-fav-btn:focus-visible,
  .fc-rate-btn:focus-visible {
    outline: 2px solid var(--sl-color-text-accent);
    outline-offset: 2px;
  }

  /* toolbar right group */
  .fc-toolbar-right { display: flex; align-items: center; gap: 0.4rem; }

  /* favorite button */
  .fc-fav-btn {
    display: inline-flex; align-items: center; justify-content: center; padding: 0.3rem;
    border: none; border-radius: 50%; background: none;
    color: var(--sl-color-gray-3); cursor: pointer; transition: color 0.15s, transform 0.15s;
  }
  .fc-fav-btn:hover { color: #f87171; transform: scale(1.15); }
  .fc-fav-btn.fc-fav-on { color: #ef4444; }
  .fc-fav-btn.fc-fav-on svg { fill: #ef4444; }

  /* favorites filter active */
  .fc-fav-active { background: #fecaca; color: #b91c1c !important; border-color: #fca5a5 !important; }

  /* rating buttons */
  .fc-rating {
    display: flex; gap: 0.5rem; justify-content: center; margin-bottom: 0.5rem;
  }
  .fc-rate-btn {
    padding: 0.4rem 1.2rem; border-radius: 999rem; font-size: var(--sl-text-sm); font-weight: 600;
    cursor: pointer; border: 2px solid var(--sl-color-gray-5); background: none;
    color: var(--sl-color-white); transition: all 0.15s;
    display: inline-flex; align-items: center; gap: 0.35rem;
  }
  .fc-rate-key {
    display: inline-flex; align-items: center; justify-content: center;
    width: 1.2em; height: 1.2em; border-radius: 0.2rem;
    background: var(--sl-color-gray-6); font-size: 0.75em; font-weight: 700;
    color: var(--sl-color-gray-3); line-height: 1;
  }
  .fc-rate-again { border-color: #f87171; color: #f87171; }
  .fc-rate-again:hover { background: #f87171; color: var(--sl-color-black); }
  .fc-rate-again:hover .fc-rate-key { background: rgba(0,0,0,0.2); color: var(--sl-color-black); }
  .fc-rate-hard { border-color: #fbbf24; color: #fbbf24; }
  .fc-rate-hard:hover { background: #fbbf24; color: var(--sl-color-black); }
  .fc-rate-hard:hover .fc-rate-key { background: rgba(0,0,0,0.2); color: var(--sl-color-black); }
  .fc-rate-easy { border-color: #4ade80; color: #4ade80; }
  .fc-rate-easy:hover { background: #4ade80; color: var(--sl-color-black); }
  .fc-rate-easy:hover .fc-rate-key { background: rgba(0,0,0,0.2); color: var(--sl-color-black); }

  /* stats */
  .fc-stats-line { color: var(--sl-color-text-accent); font-weight: 600; }
  .fc-lifetime-stats { font-size: var(--sl-text-sm); color: var(--sl-color-gray-3); margin-bottom: 1rem; text-align: center; }

  /* ---- Summary screen ---- */
  .fc-summary { text-align: center; }

  .fc-summary-stats {
    display: flex; gap: 1rem; justify-content: center; margin: 1.25rem 0;
  }
  .fc-stat {
    display: flex; flex-direction: column; align-items: center; gap: 0.15rem;
    padding: 0.6rem 1rem; border-radius: 0.5rem; border: 1px solid var(--sl-color-gray-5);
    background: var(--sl-color-black); min-width: 60px;
  }
  .fc-stat-num { font-size: 1.5rem; font-weight: 700; line-height: 1; }
  .fc-stat-label { font-size: var(--sl-text-2xs); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
  .fc-stat-easy .fc-stat-num { color: #4ade80; }
  .fc-stat-easy { border-color: #4ade80; }
  .fc-stat-hard .fc-stat-num { color: #fbbf24; }
  .fc-stat-hard { border-color: #fbbf24; }
  .fc-stat-again .fc-stat-num { color: #f87171; }
  .fc-stat-again { border-color: #f87171; }
  .fc-stat-skip .fc-stat-num { color: var(--sl-color-gray-3); }

  .fc-summary-actions { display: flex; gap: 0.65rem; justify-content: center; flex-wrap: wrap; margin-bottom: 1.25rem; }

  .fc-summary-details { text-align: left; margin-top: 0.5rem; }
  .fc-sum-toggle {
    cursor: pointer; font-size: var(--sl-text-sm); font-weight: 600; color: var(--sl-color-gray-3);
    padding: 0.4rem 0; user-select: none;
  }
  .fc-sum-toggle:hover { color: var(--sl-color-white); }

  .fc-summary-table-wrap {
    max-height: 400px; overflow-y: auto; margin-top: 0.5rem;
    border: 1px solid var(--sl-color-gray-5); border-radius: 0.5rem;
  }
  .fc-summary-table { width: 100%; border-collapse: collapse; font-size: var(--sl-text-sm); }
  .fc-summary-table thead { position: sticky; top: 0; background: var(--sl-color-black); z-index: 1; }
  .fc-summary-table th {
    padding: 0.5rem 0.65rem; text-align: left; font-weight: 600;
    border-bottom: 2px solid var(--sl-color-gray-5); color: var(--sl-color-gray-2);
    font-size: var(--sl-text-xs);
  }
  .fc-summary-table td { padding: 0.4rem 0.65rem; border-bottom: 1px solid var(--sl-color-gray-6); }
  .fc-sum-nl { color: var(--sl-color-white); font-weight: 600; }
  .fc-sum-en { color: var(--sl-color-gray-2); }
  .fc-sum-rating { font-weight: 700; font-size: var(--sl-text-xs); text-align: center; width: 60px; }
  .fc-sum-easy .fc-sum-rating { color: #4ade80; }
  .fc-sum-hard .fc-sum-rating { color: #fbbf24; }
  .fc-sum-again .fc-sum-rating { color: #f87171; }
  .fc-sum-again { background-color: rgba(248, 113, 113, 0.08); }
  .fc-sum-skip .fc-sum-rating { color: var(--sl-color-gray-3); }

  /* screen-reader only */
  .sr-only {
    position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
    overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0;
  }

  /* Mobile responsiveness */
  @media (max-width: 480px) {
    .fc-word { font-size: 1.4rem; }
    .fc-answer { font-size: 1.15rem; }
    .fc-card { padding: 1.5rem 1rem; min-height: 170px; }
    .fc-nav { width: 36px; height: 70px; font-size: 1.3rem; }
    .fc-shortcut-hint { display: none; }
    .fc-topic-grid { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); }
    .fc-summary-stats { gap: 0.5rem; }
    .fc-stat { padding: 0.4rem 0.6rem; min-width: 50px; }
    .fc-stat-num { font-size: 1.2rem; }
    .fc-rate-key { display: none; }
  }
  @media (pointer: coarse) {
    .fc-nav { min-width: 44px; min-height: 44px; }
    .fc-btn { min-height: 44px; }
    .fc-dir-btn { min-height: 40px; padding: 0.5rem 1rem; }
    .fc-rate-btn { min-height: 44px; padding: 0.5rem 1.2rem; }
    .fc-fav-btn { min-width: 44px; min-height: 44px; }
    .fc-audio-btn { min-width: 44px; min-height: 44px; }
    .fc-rate-key { display: none; }
  }
</style>
