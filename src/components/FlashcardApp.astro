---
// FlashcardApp – Dutch vocabulary flashcard practice.
// Two-way cards (Dutch→English / English→Dutch / Mixed), single-button
// flow, keyboard shortcuts, reshuffle. Standalone audio via Web Speech API.
---

<flashcard-app id="flashcard-app"></flashcard-app>

<script>
/* Standalone audio handler */
document.addEventListener("click", (e) => {
  const btn = (e.target as Element).closest?.(".dutch-audio-btn") as HTMLButtonElement | null;
  if (!btn) return;
  const text = btn.dataset.text;
  if (!text) return;
  speechSynthesis.cancel();
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "nl-NL";
  utter.rate = 0.9;
  speechSynthesis.speak(utter);
});

function speakDutch(text: string) {
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "nl-NL";
  u.rate = 0.9;
  speechSynthesis.speak(u);
}

import { DECKS, type Word } from "../data/flashcard-decks";
const TOPICS = DECKS;

type Direction = "nl-en" | "en-nl" | "mixed";

class FlashcardApp extends HTMLElement {
  selectedTopics: Set<number> = new Set();
  cards: Word[] = [];
  order: number[] = [];
  current = 0;
  flipped = false;
  direction: Direction = "mixed";
  /* per-card: true = show Dutch first, false = show English first */
  showDutchFirst: boolean[] = [];

  static SVG = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;

  private _keyHandler: ((e: KeyboardEvent) => void) | null = null;

  connectedCallback() {
    this.renderTopicGrid();
  }

  shuffle<T>(arr: T[]): T[] {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  esc(s: string): string {
    return s.replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  }

  bindKeys() {
    this.unbindKeys();
    this._keyHandler = (e: KeyboardEvent) => {
      if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) return;
      if (e.key === " " || e.key === "Enter") {
        e.preventDefault();
        this.advance();
      } else if (e.key === "ArrowRight") {
        e.preventDefault();
        if (this.flipped) { this.current++; this.flipped = false; this.renderCard(); }
      } else if (e.key === "ArrowLeft") {
        e.preventDefault();
        if (this.current > 0) { this.current--; this.flipped = false; this.renderCard(); }
      }
    };
    document.addEventListener("keydown", this._keyHandler);
  }

  unbindKeys() {
    if (this._keyHandler) {
      document.removeEventListener("keydown", this._keyHandler);
      this._keyHandler = null;
    }
  }

  advance() {
    if (!this.flipped) {
      this.flipped = true;
      /* Auto-play Dutch audio when revealing Dutch side */
      const card = this.cards[this.order[this.current]];
      if (!this.showDutchFirst[this.current]) {
        speakDutch(card.dutch);
      }
      this.renderCard();
    } else {
      this.current++;
      this.flipped = false;
      this.renderCard();
    }
  }

  /* ---- topic selection screen ---- */

  renderTopicGrid() {
    this.unbindKeys();
    const totalSelected = [...this.selectedTopics].reduce(
      (sum, i) => sum + TOPICS[i].words.length, 0
    );

    const dirLabels: Record<Direction, string> = {
      "nl-en": "Dutch → English",
      "en-nl": "English → Dutch",
      "mixed": "Mixed (both ways)",
    };

    this.innerHTML = `
      <div class="fc-container">
        <h2 class="fc-heading">Choose Topics</h2>
        <p class="fc-subheading">Select topics, pick a direction, then start.</p>

        <div class="fc-topic-grid">
          ${TOPICS.map((t, i) => `
            <button class="fc-topic-card ${this.selectedTopics.has(i) ? "fc-topic-selected" : ""}"
                    data-index="${i}" type="button">
              <span class="fc-topic-check">${this.selectedTopics.has(i) ? "&#10003;" : ""}</span>
              <span class="fc-topic-name">${t.name}</span>
              <span class="fc-topic-count">${t.words.length} words</span>
            </button>
          `).join("")}
        </div>

        <div class="fc-direction">
          ${(["nl-en", "en-nl", "mixed"] as Direction[]).map(d => `
            <button class="fc-dir-btn ${this.direction === d ? "fc-dir-active" : ""}"
                    data-dir="${d}" type="button">${dirLabels[d]}</button>
          `).join("")}
        </div>

        <div class="fc-actions">
          <button class="fc-btn fc-btn-secondary" id="fc-select-all" type="button">
            ${this.selectedTopics.size === TOPICS.length ? "Deselect All" : "Select All"}
          </button>
          <button class="fc-btn fc-btn-primary" id="fc-start" type="button"
                  ${totalSelected === 0 ? "disabled" : ""}>
            Start (${totalSelected} cards)
          </button>
        </div>
      </div>`;

    this.querySelectorAll<HTMLButtonElement>(".fc-topic-card").forEach((btn) => {
      btn.addEventListener("click", () => {
        const idx = Number(btn.dataset.index);
        this.selectedTopics.has(idx) ? this.selectedTopics.delete(idx) : this.selectedTopics.add(idx);
        this.renderTopicGrid();
      });
    });

    this.querySelectorAll<HTMLButtonElement>(".fc-dir-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        this.direction = btn.dataset.dir as Direction;
        this.renderTopicGrid();
      });
    });

    this.querySelector("#fc-select-all")!.addEventListener("click", () => {
      if (this.selectedTopics.size === TOPICS.length) this.selectedTopics.clear();
      else TOPICS.forEach((_, i) => this.selectedTopics.add(i));
      this.renderTopicGrid();
    });

    this.querySelector("#fc-start")!.addEventListener("click", () => {
      if (totalSelected > 0) this.startPractice();
    });
  }

  startPractice() {
    this.cards = [];
    for (const i of this.selectedTopics) this.cards.push(...TOPICS[i].words);
    this.order = this.shuffle([...Array(this.cards.length).keys()]);
    this.showDutchFirst = this.order.map(() => {
      if (this.direction === "nl-en") return true;
      if (this.direction === "en-nl") return false;
      return Math.random() < 0.5;
    });
    this.current = 0;
    this.flipped = false;
    this.bindKeys();
    this.renderCard();
  }

  reshuffle() {
    this.order = this.shuffle([...Array(this.cards.length).keys()]);
    this.showDutchFirst = this.order.map(() => {
      if (this.direction === "nl-en") return true;
      if (this.direction === "en-nl") return false;
      return Math.random() < 0.5;
    });
    this.current = 0;
    this.flipped = false;
    this.renderCard();
  }

  renderCard() {
    const total = this.order.length;

    if (this.current >= total) {
      this.unbindKeys();
      this.innerHTML = `
        <div class="fc-container fc-center">
          <h2 class="fc-heading">All done!</h2>
          <p class="fc-subheading">You reviewed all ${total} cards.</p>
          <div class="fc-actions">
            <button class="fc-btn fc-btn-secondary" id="fc-back" type="button">Back to Topics</button>
            <button class="fc-btn fc-btn-primary" id="fc-restart" type="button">Restart</button>
          </div>
        </div>`;
      this.querySelector("#fc-back")!.addEventListener("click", () => this.renderTopicGrid());
      this.querySelector("#fc-restart")!.addEventListener("click", () => this.startPractice());
      return;
    }

    const card = this.cards[this.order[this.current]];
    const dutch = this.showDutchFirst[this.current];
    const num = this.current + 1;
    const pct = Math.round((this.current / total) * 100);

    /* front / back content based on direction */
    const frontWord = dutch ? card.dutch : card.english;
    const frontSub = dutch && card.ipa ? `<div class="fc-ipa">${card.ipa}</div>` : "";
    const frontAudio = dutch
      ? `<button class="dutch-audio-btn fc-audio-btn" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${FlashcardApp.SVG}</button>`
      : "";
    const frontLabel = dutch ? "NL" : "EN";

    const backWord = dutch ? card.english : card.dutch;
    const backSub = !dutch && card.ipa ? `<div class="fc-ipa">${card.ipa}</div>` : "";
    const backAudio = !dutch
      ? `<button class="dutch-audio-btn fc-audio-btn" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${FlashcardApp.SVG}</button>`
      : "";
    const backLabel = dutch ? "EN" : "NL";

    /* Build word list for the bottom panel */
    const wordListRows = this.order.map((idx, pos) => {
      const w = this.cards[idx];
      const isDutchFirst = this.showDutchFirst[pos];
      const isCurrent = pos === this.current;
      const visited = pos < this.current;
      const cls = isCurrent ? "fc-wl-current" : visited ? "fc-wl-visited" : "";
      /* Show only the "question" side; hover reveals answer */
      const shown = isDutchFirst ? this.esc(w.dutch) : this.esc(w.english);
      const hidden = isDutchFirst ? this.esc(w.english) : this.esc(w.dutch);
      return `<tr class="${cls}" data-pos="${pos}"><td class="fc-wl-num">${pos + 1}</td><td class="fc-wl-shown">${shown}</td><td class="fc-wl-hidden">${hidden}</td></tr>`;
    }).join("");

    this.innerHTML = `
      <div class="fc-container">
        <div class="fc-toolbar">
          <button class="fc-btn fc-btn-small fc-btn-secondary" id="fc-back" type="button">Back</button>
          <span class="fc-counter">${num} / ${total}</span>
          <button class="fc-btn fc-btn-small fc-btn-secondary" id="fc-reshuffle" type="button" title="Reshuffle cards">Shuffle</button>
        </div>
        <div class="fc-progress-bar"><div class="fc-progress-fill" style="width:${pct}%"></div></div>

        <div class="fc-card-row">
          <button class="fc-nav fc-nav-prev ${this.current === 0 ? "fc-nav-disabled" : ""}" id="fc-prev" type="button" title="Previous card" aria-label="Previous card">&#8249;</button>
          <div class="fc-card" id="fc-card">
            <div class="fc-card-inner">
              <div class="fc-lang-badge">${frontLabel}</div>
              <div class="fc-word">${frontWord}</div>
              ${frontSub}
              ${frontAudio}
              ${this.flipped ? `
                <div class="fc-divider"></div>
                <div class="fc-lang-badge fc-lang-badge-answer">${backLabel}</div>
                <div class="fc-answer">${backWord}</div>
                ${backSub}
                ${backAudio}
              ` : ""}
            </div>
          </div>
          <button class="fc-nav fc-nav-next" id="fc-next" type="button" title="${this.flipped ? "Next card" : "Show Answer"}" aria-label="Next">&#8250;</button>
        </div>

        <div class="fc-shortcut-hint">&larr; Prev &nbsp; Space / Enter &nbsp; Next &rarr;</div>

        <details class="fc-wordlist-toggle">
          <summary class="fc-wl-summary">All words (${total})</summary>
          <div class="fc-wordlist-wrap">
            <table class="fc-wordlist"><tbody>${wordListRows}</tbody></table>
          </div>
        </details>
      </div>`;

    this.querySelector("#fc-next")!.addEventListener("click", () => this.advance());
    this.querySelector("#fc-prev")!.addEventListener("click", () => {
      if (this.current > 0) { this.current--; this.flipped = false; this.renderCard(); }
    });
    this.querySelector("#fc-card")!.addEventListener("click", (e) => {
      if ((e.target as Element).closest(".dutch-audio-btn")) return;
      this.advance();
    });
    this.querySelector("#fc-back")!.addEventListener("click", () => { this.unbindKeys(); this.renderTopicGrid(); });
    this.querySelector("#fc-reshuffle")!.addEventListener("click", () => this.reshuffle());
    /* Click word list row to jump to that card */
    this.querySelectorAll<HTMLTableRowElement>(".fc-wordlist tr[data-pos]").forEach(row => {
      row.addEventListener("click", () => {
        this.current = Number(row.dataset.pos);
        this.flipped = false;
        this.renderCard();
      });
    });
  }
}

customElements.define("flashcard-app", FlashcardApp);
</script>

<style>
  .fc-container { max-width: 640px; margin: 0 auto; }
  .fc-center { text-align: center; }
  .fc-heading { font-size: var(--sl-text-h4); font-weight: 700; margin: 0 0 0.25rem; color: var(--sl-color-white); line-height: var(--sl-line-height-headings); }
  .fc-subheading { margin: 0 0 1.25rem; color: var(--sl-color-gray-3); font-size: var(--sl-text-sm); }

  /* topic grid */
  .fc-topic-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 0.65rem; margin-bottom: 1rem;
  }
  .fc-topic-card {
    position: relative; display: flex; flex-direction: column; align-items: flex-start;
    gap: 0.15rem; padding: 0.75rem 0.85rem; border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem; background: var(--sl-color-black); cursor: pointer; text-align: left;
    color: var(--sl-color-white); box-shadow: var(--sl-shadow-sm);
    transition: border-color 0.15s, background-color 0.15s;
  }
  .fc-topic-card:hover { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); }
  .fc-topic-card.fc-topic-selected { border-color: var(--sl-color-accent); background-color: var(--sl-color-accent-low); }
  .fc-topic-check { position: absolute; top: 0.45rem; right: 0.6rem; font-size: var(--sl-text-sm); font-weight: 700; color: var(--sl-color-accent-high); line-height: 1; }
  .fc-topic-name { font-weight: 600; font-size: var(--sl-text-sm); line-height: 1.25; }
  .fc-topic-count { font-size: var(--sl-text-xs); color: var(--sl-color-gray-3); }

  /* direction picker */
  .fc-direction { display: flex; gap: 0.4rem; justify-content: center; margin-bottom: 1.25rem; flex-wrap: wrap; }
  .fc-dir-btn {
    padding: 0.4rem 0.9rem; border-radius: 999rem; font-size: var(--sl-text-xs); font-weight: 600;
    cursor: pointer; border: 1px solid var(--sl-color-gray-5); background: none;
    color: var(--sl-color-white); transition: all 0.15s;
  }
  .fc-dir-btn:hover { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); }
  .fc-dir-btn.fc-dir-active { background: var(--sl-color-text-accent); color: var(--sl-color-black); border-color: var(--sl-color-text-accent); }

  /* actions */
  .fc-actions { display: flex; gap: 0.65rem; justify-content: center; flex-wrap: wrap; }

  /* buttons */
  .fc-btn {
    padding: 0.55rem 1.4rem; border-radius: 999rem; font-size: var(--sl-text-sm); font-weight: 600;
    cursor: pointer; border: 1px solid var(--sl-color-gray-5); background: none;
    color: var(--sl-color-white); transition: background-color 0.15s, opacity 0.15s;
  }
  .fc-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .fc-btn-primary { background: var(--sl-color-text-accent); color: var(--sl-color-black); border-color: var(--sl-color-text-accent); }
  .fc-btn-primary:hover:not(:disabled) { opacity: 0.88; }
  .fc-btn-secondary:hover:not(:disabled) { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); }
  .fc-btn-small { padding: 0.3rem 0.85rem; font-size: var(--sl-text-xs); }

  /* toolbar */
  .fc-toolbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
  .fc-counter { font-size: var(--sl-text-xs); color: var(--sl-color-gray-3); font-variant-numeric: tabular-nums; }

  /* progress */
  .fc-progress-bar { width: 100%; height: 4px; border-radius: 2px; background: var(--sl-color-gray-5); margin-bottom: 1.25rem; overflow: hidden; }
  .fc-progress-fill { height: 100%; border-radius: 2px; background: var(--sl-color-accent); transition: width 0.3s ease; }

  /* card row with nav arrows */
  .fc-card-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; }
  .fc-nav {
    flex-shrink: 0; width: 40px; height: 80px; display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem; line-height: 1; border: 1px solid var(--sl-color-gray-5); border-radius: 0.5rem;
    background: none; color: var(--sl-color-gray-3); cursor: pointer; transition: all 0.15s;
    user-select: none;
  }
  .fc-nav:hover:not(.fc-nav-disabled) { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); color: var(--sl-color-white); }
  .fc-nav-disabled { opacity: 0.2; cursor: default; }

  /* card */
  .fc-card {
    flex: 1; min-width: 0;
    border: 1px solid var(--sl-color-gray-5); border-radius: 0.5rem;
    padding: 2rem 1.5rem; min-height: 200px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    text-align: center; background: var(--sl-color-black);
    box-shadow: var(--sl-shadow-sm); transition: border-color 0.2s, background-color 0.2s;
  }
  .fc-card:hover { border-color: var(--sl-color-gray-2); background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); }
  .fc-card-inner { width: 100%; }
  .fc-lang-badge {
    display: inline-block; font-size: var(--sl-text-2xs); font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.05em; padding: 0.15rem 0.5rem; border-radius: 0.25rem;
    background: var(--sl-color-gray-5); color: var(--sl-color-gray-2); margin-bottom: 0.5rem;
  }
  .fc-lang-badge-answer { background: var(--sl-color-accent-low); color: var(--sl-color-accent-high); }
  .fc-word { font-size: 1.75rem; font-weight: 700; color: var(--sl-color-white); margin-bottom: 0.3rem; line-height: var(--sl-line-height-headings); }
  .fc-ipa { font-size: var(--sl-text-sm); color: var(--sl-color-gray-3); margin-bottom: 0.5rem; }
  .fc-audio-btn {
    display: inline-flex; align-items: center; justify-content: center; padding: 0.4rem;
    border: 1px solid var(--sl-color-gray-5); border-radius: 0.25rem; background: none;
    color: var(--sl-color-text-accent); cursor: pointer; transition: background-color 0.15s;
  }
  .fc-audio-btn:hover { background-color: var(--sl-color-accent-low); }
  .fc-divider { width: 60px; height: 1px; background: var(--sl-color-gray-5); margin: 1rem auto; }
  .fc-answer { font-size: 1.4rem; font-weight: 600; color: var(--sl-color-text-accent); margin-bottom: 0.2rem; }
  .fc-shortcut-hint { text-align: center; font-size: var(--sl-text-2xs); color: var(--sl-color-gray-3); margin-bottom: 1rem; }

  /* word list panel */
  .fc-wordlist-toggle { margin-top: 0.5rem; }
  .fc-wl-summary {
    cursor: pointer; font-size: var(--sl-text-xs); font-weight: 600; color: var(--sl-color-gray-3);
    padding: 0.4rem 0; user-select: none;
  }
  .fc-wl-summary:hover { color: var(--sl-color-white); }
  .fc-wordlist-wrap { max-height: 300px; overflow-y: auto; margin-top: 0.5rem; }
  .fc-wordlist {
    width: 100%; border-collapse: collapse; font-size: var(--sl-text-xs);
  }
  .fc-wordlist tr { cursor: pointer; transition: background-color 0.1s; }
  .fc-wordlist tr:hover { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); }
  .fc-wordlist td { padding: 0.25rem 0.5rem; border-bottom: 1px solid var(--sl-color-gray-6); }
  .fc-wl-num { width: 2rem; color: var(--sl-color-gray-3); text-align: right; font-variant-numeric: tabular-nums; }
  .fc-wl-shown { color: var(--sl-color-white); }
  .fc-wl-hidden { color: transparent; transition: color 0.15s; }
  .fc-wordlist tr:hover .fc-wl-hidden { color: var(--sl-color-gray-3); }
  .fc-wl-current { background-color: var(--sl-color-accent-low); }
  .fc-wl-current td { font-weight: 600; }
  .fc-wl-visited { opacity: 0.5; }
</style>
