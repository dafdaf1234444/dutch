---
// PageFlashcards – Scans the current page's tables for Dutch vocabulary
// and renders a mini flashcard practice section. Stable DOM architecture:
// builds skeleton once, wires events once, renderCard() does targeted updates.
// Includes difficulty ratings, running tally, session summary.
---

<page-flashcards id="page-flashcards"></page-flashcards>

<script>
import { speakDutch } from "../scripts/dutch-speech";

const DUTCH_HEADERS = new Set([
  "dutch", "dutch word", "dutch expression", "dutch phrase",
  "example", "example sentence", "example sentences",
  "dialogue", "infinitive", "word", "diminutive",
  "singular", "plural", "original", "conjugation",
  "stem", "correct stem", "statement", "question",
  "tag", "example question", "example answer",
  "sentence", "base verb", "prefix",
  "normal", "inverted (question)",
  "name", "spelling", "ik", "jij", "hij/zij/het", "wij",
  "raw stem", "position 1", "verb", "subject", "rest",
  "example words", "proof (vowel follows)",
]);
const ENGLISH_HEADERS = new Set(["english", "meaning", "translation", "english meaning"]);
const IPA_HEADERS = new Set(["ipa", "pronunciation"]);

const FC_STORAGE_KEY = "dutch-fc-progress";

interface Card { dutch: string; english: string; ipa: string; }

function cleanText(cell: Element): string {
  const clone = cell.cloneNode(true) as Element;
  clone.querySelectorAll("em").forEach(em => em.remove());
  clone.querySelectorAll(".dutch-audio-btn").forEach(btn => btn.remove());
  let text = clone.textContent?.trim() ?? "";
  text = text.replace(/\s*\([^)]*[a-zA-Z][^)]*\)\s*/g, " ");
  text = text.replace(/\[[^\]]*\]/g, "");
  text = text.replace(/\/[^/]+\//g, "");
  text = text.replace(/\u2192/g, "");
  return text.replace(/\s+/g, " ").trim();
}

function extractCards(): Card[] {
  const cards: Card[] = [];
  const seen = new Set<string>();
  for (const table of document.querySelectorAll("table")) {
    const headers = table.querySelectorAll("thead th");
    let dCol = -1, eCol = -1, iCol = -1;
    headers.forEach((th, i) => {
      const t = th.textContent?.trim().toLowerCase() ?? "";
      if (dCol === -1 && DUTCH_HEADERS.has(t)) dCol = i;
      if (eCol === -1 && ENGLISH_HEADERS.has(t)) eCol = i;
      if (iCol === -1 && IPA_HEADERS.has(t)) iCol = i;
    });
    if (dCol === -1) continue;
    for (const row of table.querySelectorAll("tbody tr")) {
      const cells = row.querySelectorAll("td");
      const dutch = cleanText(cells[dCol]);
      if (!dutch || dutch.length < 2) continue;
      const key = dutch.toLowerCase();
      if (seen.has(key)) continue;
      seen.add(key);
      cards.push({
        dutch,
        english: eCol >= 0 ? cleanText(cells[eCol]) : "",
        ipa: iCol >= 0 ? cells[iCol]?.textContent?.trim() ?? "" : "",
      });
    }
  }
  return cards;
}

type Dir = "nl-en" | "en-nl" | "mixed" | "listen";

class PageFlashcards extends HTMLElement {
  cards: Card[] = [];
  order: number[] = [];
  showDutchFirst: boolean[] = [];
  current = 0;
  flipped = false;
  direction: Dir = "mixed";
  private _kh: ((e: KeyboardEvent) => void) | null = null;
  private sessionRatings: Map<number, number> = new Map();

  /* DOM refs – set once in buildDOM() */
  private setupEl!: HTMLElement;
  private practiceEl!: HTMLElement;
  private summaryEl!: HTMLElement;
  private countEl!: HTMLElement;
  private pfillEl!: HTMLElement;
  private faceEl!: HTMLElement;
  private hintEl!: HTMLElement;
  private rateRowEl!: HTMLElement;
  private prevEl!: HTMLButtonElement;
  private keysEl!: HTMLElement;
  private tallyEasyEl!: HTMLElement;
  private tallyHardEl!: HTMLElement;
  private tallyAgainEl!: HTMLElement;

  static SVG = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;

  connectedCallback() {
    const init = () => {
      this.cards = extractCards();
      if (this.cards.length < 2) { this.style.display = "none"; return; }
      this.buildDOM();
    };
    if ("requestIdleCallback" in window) requestIdleCallback(init);
    else requestAnimationFrame(() => setTimeout(init, 0));
  }

  /* ---- Build DOM skeleton once, wire all events once ---- */

  private buildDOM() {
    this.innerHTML = `
      <div class="pf-widget" id="pf-setup">
        <div class="pf-header-bar">
          <span class="pf-header-title">Flashcards</span>
          <span class="pf-header-count">${this.cards.length} cards</span>
        </div>
        <div class="pf-dir-row">
          <button class="pf-dir ${this.direction === "nl-en" ? "pf-dir-on" : ""}" data-d="nl-en" type="button">NL\u2192EN</button>
          <button class="pf-dir ${this.direction === "en-nl" ? "pf-dir-on" : ""}" data-d="en-nl" type="button">EN\u2192NL</button>
          <button class="pf-dir ${this.direction === "mixed" ? "pf-dir-on" : ""}" data-d="mixed" type="button">Mixed</button>
          <button class="pf-dir ${this.direction === "listen" ? "pf-dir-on" : ""}" data-d="listen" type="button">Listen</button>
        </div>
        <button class="pf-start" id="pf-start" type="button">Start Practice</button>
        <div class="pf-link"><a href="/dutch/flashcards/">Practice all topics \u2192</a></div>
      </div>

      <div class="pf-widget" id="pf-practice" style="display:none">
        <div class="pf-toolbar">
          <button class="pf-tbtn" id="pf-close" type="button">Close</button>
          <span class="pf-count" id="pf-count"></span>
          <button class="pf-tbtn" id="pf-reshuffle" type="button">Shuffle</button>
        </div>
        <div class="pf-pbar"><div class="pf-pfill" id="pf-pfill"></div></div>
        <div class="pf-tally" id="pf-tally">
          <span class="pf-tb pf-tb-easy" id="pf-tally-easy"></span>
          <span class="pf-tb pf-tb-hard" id="pf-tally-hard"></span>
          <span class="pf-tb pf-tb-again" id="pf-tally-again"></span>
        </div>
        <div class="pf-card-row">
          <button class="pf-nav" id="pf-prev" type="button" aria-label="Previous">&#8249;</button>
          <div class="pf-card" id="pf-card">
            <div class="pf-face" id="pf-face"></div>
            <div class="pf-card-bottom">
              <div class="pf-hint" id="pf-hint">Tap to reveal</div>
              <div class="pf-rate-row" id="pf-rate-row">
                <button class="pf-rate pf-rate-again" data-ease="1" type="button">Again</button>
                <button class="pf-rate pf-rate-hard" data-ease="2" type="button">Hard</button>
                <button class="pf-rate pf-rate-easy" data-ease="3" type="button">Easy</button>
              </div>
            </div>
          </div>
          <button class="pf-nav" id="pf-next" type="button" aria-label="Next">&#8250;</button>
        </div>
        <div class="pf-keys" id="pf-keys"></div>
      </div>

      <div class="pf-widget" id="pf-summary" style="display:none"></div>`;

    /* Cache DOM refs */
    this.setupEl = this.querySelector("#pf-setup")!;
    this.practiceEl = this.querySelector("#pf-practice")!;
    this.summaryEl = this.querySelector("#pf-summary")!;
    this.countEl = this.querySelector("#pf-count")!;
    this.pfillEl = this.querySelector("#pf-pfill")!;
    this.faceEl = this.querySelector("#pf-face")!;
    this.hintEl = this.querySelector("#pf-hint")!;
    this.rateRowEl = this.querySelector("#pf-rate-row")!;
    this.prevEl = this.querySelector("#pf-prev") as HTMLButtonElement;
    this.keysEl = this.querySelector("#pf-keys")!;
    this.tallyEasyEl = this.querySelector("#pf-tally-easy")!;
    this.tallyHardEl = this.querySelector("#pf-tally-hard")!;
    this.tallyAgainEl = this.querySelector("#pf-tally-again")!;

    /* ---- Wire events once ---- */

    /* Direction buttons */
    this.querySelectorAll<HTMLButtonElement>(".pf-dir").forEach(b => {
      b.addEventListener("click", () => {
        this.direction = b.dataset.d as Dir;
        this.querySelectorAll(".pf-dir").forEach(d => d.classList.toggle("pf-dir-on", d === b));
      });
    });

    /* Start */
    this.querySelector("#pf-start")!.addEventListener("click", () => this.start());

    /* Close → back to setup */
    this.querySelector("#pf-close")!.addEventListener("click", () => {
      this.unbindKeys();
      this.showScreen("setup");
    });

    /* Shuffle */
    this.querySelector("#pf-reshuffle")!.addEventListener("click", () => this.reshuffle());

    /* Card click → advance (skip audio/rate clicks) */
    this.querySelector("#pf-card")!.addEventListener("click", (e) => {
      if ((e.target as Element).closest(".dutch-audio-btn")) return;
      if ((e.target as Element).closest(".pf-rate-row")) return;
      this.advance();
    });

    /* Nav buttons */
    this.querySelector("#pf-next")!.addEventListener("click", () => this.advance());
    this.querySelector("#pf-prev")!.addEventListener("click", () => {
      if (this.current > 0) { this.current--; this.flipped = false; this.renderCard(); }
    });

    /* Rate buttons – event delegation on the row */
    this.rateRowEl.addEventListener("click", (e) => {
      const btn = (e.target as Element).closest(".pf-rate") as HTMLButtonElement;
      if (!btn) return;
      e.stopPropagation();
      const card = this.cards[this.order[this.current]];
      const ease = Number(btn.dataset.ease);
      this.rateToStorage(card, ease);
      this.sessionRatings.set(this.current, ease);
      this.current++;
      this.flipped = false;
      this.renderCard();
    });

    /* Summary clicks – event delegation */
    this.summaryEl.addEventListener("click", (e) => {
      const target = e.target as Element;
      if (target.closest("#pf-close-sum")) { this.unbindKeys(); this.showScreen("setup"); }
      else if (target.closest("#pf-restart")) this.start();
      else if (target.closest("#pf-review-hard")) {
        const btn = target.closest("#pf-review-hard") as HTMLElement;
        const indices = JSON.parse(btn.dataset.cards || "[]");
        if (indices.length) this.startWithCards(indices);
      }
    });
  }

  /* ---- Screen toggling ---- */

  private showScreen(screen: "setup" | "practice" | "summary") {
    this.setupEl.style.display = screen === "setup" ? "" : "none";
    this.practiceEl.style.display = screen === "practice" ? "" : "none";
    this.summaryEl.style.display = screen === "summary" ? "" : "none";
  }

  /* ---- Helpers ---- */

  shuffle(arr: number[]): number[] {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  esc(s: string): string {
    return s.replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  }

  private rateToStorage(card: Card, ease: number): void {
    try {
      const raw = localStorage.getItem(FC_STORAGE_KEY);
      const storage = raw ? JSON.parse(raw) : { cards: {}, stats: { totalReviews: 0, lastDate: "", streak: 0 } };
      const key = card.dutch.toLowerCase();
      const prev = storage.cards[key] ?? { ease: 0, lastSeen: 0, reviews: 0, favorite: false };
      storage.cards[key] = { ...prev, ease, lastSeen: Date.now(), reviews: prev.reviews + 1 };
      storage.stats.totalReviews++;
      const today = new Date().toISOString().slice(0, 10);
      const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
      if (storage.stats.lastDate !== today) {
        storage.stats.streak = storage.stats.lastDate === yesterday ? storage.stats.streak + 1 : 1;
        storage.stats.lastDate = today;
      }
      localStorage.setItem(FC_STORAGE_KEY, JSON.stringify(storage));
    } catch { /* localStorage unavailable */ }
  }

  bindKeys() {
    this.unbindKeys();
    this._kh = (e: KeyboardEvent) => {
      if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) return;
      if (e.key === " " || e.key === "Enter") { e.preventDefault(); this.advance(); }
      else if (e.key === "ArrowRight") { e.preventDefault(); if (this.flipped) { this.current++; this.flipped = false; this.renderCard(); } }
      else if (e.key === "ArrowLeft") { e.preventDefault(); if (this.current > 0) { this.current--; this.flipped = false; this.renderCard(); } }
      else if (this.flipped && (e.key === "1" || e.key === "2" || e.key === "3")) {
        e.preventDefault();
        const card = this.cards[this.order[this.current]];
        const ease = Number(e.key);
        this.rateToStorage(card, ease);
        this.sessionRatings.set(this.current, ease);
        this.current++;
        this.flipped = false;
        this.renderCard();
      }
    };
    document.addEventListener("keydown", this._kh);
  }

  unbindKeys() {
    if (this._kh) { document.removeEventListener("keydown", this._kh); this._kh = null; }
  }

  advance() {
    if (!this.flipped) {
      this.flipped = true;
      if (!this.showDutchFirst[this.current]) {
        speakDutch(this.cards[this.order[this.current]].dutch);
      }
      this.renderCard();
    } else {
      this.current++;
      this.flipped = false;
      this.renderCard();
    }
  }

  buildOrder() {
    this.order = this.shuffle([...Array(this.cards.length).keys()]);
    this.showDutchFirst = this.order.map(() => {
      if (this.direction === "nl-en" || this.direction === "listen") return true;
      if (this.direction === "en-nl") return false;
      return Math.random() < 0.5;
    });
  }

  start() {
    this.buildOrder();
    this.current = 0;
    this.flipped = false;
    this.sessionRatings = new Map();
    this.bindKeys();
    this.showScreen("practice");
    this.renderCard();
  }

  startWithCards(cardIndices: number[]) {
    this.order = this.shuffle([...cardIndices]);
    this.showDutchFirst = this.order.map(() => {
      if (this.direction === "nl-en" || this.direction === "listen") return true;
      if (this.direction === "en-nl") return false;
      return Math.random() < 0.5;
    });
    this.current = 0;
    this.flipped = false;
    this.sessionRatings = new Map();
    this.bindKeys();
    this.showScreen("practice");
    this.renderCard();
  }

  reshuffle() {
    this.buildOrder();
    this.current = 0;
    this.flipped = false;
    this.sessionRatings = new Map();
    this.renderCard();
  }

  /* ---- Targeted card rendering (no full DOM rebuild) ---- */

  renderCard() {
    const total = this.order.length;

    if (this.current >= total) {
      this.renderSummary();
      return;
    }

    const card = this.cards[this.order[this.current]];
    const dutch = this.showDutchFirst[this.current];
    const isListen = this.direction === "listen";
    const num = this.current + 1;
    const pct = Math.round((this.current / total) * 100);

    /* Counter & progress bar */
    this.countEl.textContent = `${num}/${total}`;
    this.pfillEl.style.width = `${pct}%`;

    /* Prev button state */
    this.prevEl.classList.toggle("pf-nav-off", this.current === 0);

    /* Running tally */
    let easyCount = 0, hardCount = 0, againCount = 0;
    for (const [, rating] of this.sessionRatings) {
      if (rating === 3) easyCount++;
      else if (rating === 2) hardCount++;
      else if (rating === 1) againCount++;
    }
    this.tallyEasyEl.textContent = `${easyCount} easy`;
    this.tallyEasyEl.style.display = easyCount > 0 ? "" : "none";
    this.tallyHardEl.textContent = `${hardCount} hard`;
    this.tallyHardEl.style.display = hardCount > 0 ? "" : "none";
    this.tallyAgainEl.textContent = `${againCount} again`;
    this.tallyAgainEl.style.display = againCount > 0 ? "" : "none";

    /* Card face (only this inner area is rebuilt) */
    this.faceEl.innerHTML = this.buildFaceHTML(card, dutch, isListen);

    /* Toggle hint / rate-row */
    if (this.flipped) {
      this.hintEl.style.display = "none";
      this.rateRowEl.style.visibility = "visible";
    } else {
      this.hintEl.style.display = "";
      this.rateRowEl.style.visibility = "hidden";
    }

    /* Keyboard hints */
    this.keysEl.innerHTML = `&larr; Prev &nbsp; Space/Enter &nbsp; Next &rarr;${this.flipped ? " &nbsp; 1-2-3" : ""}`;

    /* Auto-play in Listen mode */
    if (isListen && !this.flipped) {
      setTimeout(() => speakDutch(card.dutch), 150);
    }
  }

  private buildFaceHTML(card: Card, dutch: boolean, isListen: boolean): string {
    if (isListen && !this.flipped) {
      return `
        <div class="pf-badge">LISTEN</div>
        <button class="dutch-audio-btn pf-audio pf-audio-big" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${PageFlashcards.SVG}</button>
        <div class="pf-listen-q">?</div>`;
    }
    if (isListen && this.flipped) {
      return `
        <div class="pf-badge">NL</div>
        <div class="pf-word">${this.esc(card.dutch)}</div>
        ${card.ipa ? `<div class="pf-ipa">${this.esc(card.ipa)}</div>` : ""}
        <button class="dutch-audio-btn pf-audio" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${PageFlashcards.SVG}</button>
        <div class="pf-divider"></div>
        <div class="pf-badge pf-badge-ans">EN</div>
        <div class="pf-answer">${this.esc(card.english)}</div>`;
    }

    const frontWord = dutch ? card.dutch : card.english;
    const frontIPA = dutch && card.ipa ? `<div class="pf-ipa">${this.esc(card.ipa)}</div>` : "";
    const frontAudio = dutch ? `<button class="dutch-audio-btn pf-audio" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${PageFlashcards.SVG}</button>` : "";
    const fLabel = dutch ? "NL" : "EN";

    let html = `
      <div class="pf-badge">${fLabel}</div>
      <div class="pf-word">${this.esc(frontWord)}</div>
      ${frontIPA}
      ${frontAudio}`;

    if (this.flipped) {
      const backWord = dutch ? card.english : card.dutch;
      const backIPA = !dutch && card.ipa ? `<div class="pf-ipa">${this.esc(card.ipa)}</div>` : "";
      const backAudio = !dutch ? `<button class="dutch-audio-btn pf-audio" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${PageFlashcards.SVG}</button>` : "";
      const bLabel = dutch ? "EN" : "NL";
      html += `
        <div class="pf-divider"></div>
        <div class="pf-badge pf-badge-ans">${bLabel}</div>
        <div class="pf-answer">${this.esc(backWord)}</div>
        ${backIPA}
        ${backAudio}`;
    }
    return html;
  }

  /* ---- Summary (rebuilt once at end of session) ---- */

  renderSummary() {
    this.unbindKeys();
    const total = this.order.length;

    let easyCount = 0, hardCount = 0, againCount = 0;
    for (let i = 0; i < total; i++) {
      const rating = this.sessionRatings.get(i);
      if (rating === 3) easyCount++;
      else if (rating === 2) hardCount++;
      else if (rating === 1) againCount++;
    }

    const hardCards: number[] = [];
    for (let i = 0; i < total; i++) {
      const rating = this.sessionRatings.get(i);
      if (rating === 1 || rating === 2) hardCards.push(this.order[i]);
    }

    const summaryRows = this.order.map((idx, pos) => {
      const w = this.cards[idx];
      const rating = this.sessionRatings.get(pos);
      let ratingLabel = "", ratingClass = "";
      if (rating === 3) { ratingLabel = "Easy"; ratingClass = "pf-sr-easy"; }
      else if (rating === 2) { ratingLabel = "Hard"; ratingClass = "pf-sr-hard"; }
      else if (rating === 1) { ratingLabel = "Again"; ratingClass = "pf-sr-again"; }
      else { ratingLabel = "\u2014"; ratingClass = "pf-sr-skip"; }
      return `<tr class="${ratingClass}">
        <td class="pf-sr-nl">${this.esc(w.dutch)}</td>
        <td class="pf-sr-en">${this.esc(w.english)}</td>
        <td class="pf-sr-rat">${ratingLabel}</td>
      </tr>`;
    }).join("");

    this.summaryEl.innerHTML = `
      <div class="pf-sum">
        <div class="pf-sum-top">
          <span class="pf-sum-title">Done!</span>
          <span class="pf-sum-sub">${total} cards reviewed</span>
        </div>
        <div class="pf-sum-badges">
          <span class="pf-sb pf-sb-easy">${easyCount} easy</span>
          <span class="pf-sb pf-sb-hard">${hardCount} hard</span>
          <span class="pf-sb pf-sb-again">${againCount} again</span>
        </div>
        <div class="pf-sum-actions">
          ${hardCards.length > 0 ? `<button class="pf-btn-pri" id="pf-review-hard" data-cards="${this.esc(JSON.stringify(hardCards))}" type="button">Review ${hardCards.length} Hard</button>` : ""}
          <button class="pf-btn-sec" id="pf-restart" type="button">Restart</button>
          <button class="pf-btn-sec" id="pf-close-sum" type="button">Close</button>
        </div>
        <div class="pf-sum-table-wrap">
          <table class="pf-sum-table">
            <thead><tr><th>Dutch</th><th>English</th><th></th></tr></thead>
            <tbody>${summaryRows}</tbody>
          </table>
        </div>
        <div class="pf-link"><a href="/dutch/flashcards/">Practice all topics \u2192</a></div>
      </div>`;

    this.showScreen("summary");
  }
}

customElements.define("page-flashcards", PageFlashcards);
</script>

<style>
  /* ========== Widget container ========== */
  .pf-widget {
    max-width: 540px;
    margin: 1.5rem auto 0;
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    padding: 1rem;
    background: var(--sl-color-bg-nav);
    box-shadow: var(--sl-shadow-sm);
  }

  /* Header bar */
  .pf-header-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.75rem;
  }
  .pf-header-title {
    font-size: var(--sl-text-base);
    font-weight: 700;
    color: var(--sl-color-white);
  }
  .pf-header-count {
    font-size: var(--sl-text-2xs);
    color: var(--sl-color-gray-3);
  }

  /* Direction pills */
  .pf-dir-row { display: flex; gap: 0.3rem; justify-content: center; margin-bottom: 0.75rem; }
  .pf-dir {
    padding: 0.25rem 0.65rem;
    border-radius: 999rem;
    font-size: var(--sl-text-xs);
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--sl-color-gray-5);
    background: none;
    color: var(--sl-color-white);
    transition: all 0.15s;
  }
  .pf-dir:hover { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); }
  .pf-dir.pf-dir-on { background: var(--sl-color-text-accent); color: var(--sl-color-black); border-color: var(--sl-color-text-accent); }

  /* Start button */
  .pf-start {
    display: block;
    width: 100%;
    padding: 0.6rem 1rem;
    border: 1px solid var(--sl-color-text-accent);
    border-radius: 999rem;
    background: none;
    color: var(--sl-color-text-accent);
    font-size: var(--sl-text-sm);
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.15s, color 0.15s;
  }
  .pf-start:hover { background: var(--sl-color-text-accent); color: var(--sl-color-black); }

  /* ========== Card Practice ========== */
  .pf-toolbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.3rem; }
  .pf-tbtn {
    padding: 0.2rem 0.55rem;
    border-radius: 999rem;
    font-size: var(--sl-text-2xs);
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--sl-color-gray-5);
    background: none;
    color: var(--sl-color-white);
    transition: all 0.15s;
  }
  .pf-tbtn:hover { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); }
  .pf-count { font-size: var(--sl-text-2xs); color: var(--sl-color-gray-3); font-variant-numeric: tabular-nums; }

  /* Progress bar */
  .pf-pbar { width: 100%; height: 3px; border-radius: 2px; background: var(--sl-color-gray-5); margin-bottom: 0.4rem; overflow: hidden; }
  .pf-pfill { height: 100%; border-radius: 2px; background: var(--sl-color-accent); transition: width 0.3s ease; }

  /* Running tally */
  .pf-tally { display: flex; gap: 0.3rem; justify-content: center; margin-bottom: 0.4rem; min-height: 1.2rem; }
  .pf-tb { font-size: var(--sl-text-2xs); font-weight: 700; padding: 0.1rem 0.4rem; border-radius: 999rem; }
  .pf-tb-easy { color: #4ade80; background: rgba(74, 222, 128, 0.12); }
  .pf-tb-hard { color: #fbbf24; background: rgba(251, 191, 36, 0.12); }
  .pf-tb-again { color: #f87171; background: rgba(248, 113, 113, 0.12); }

  /* Card row */
  .pf-card-row { display: flex; align-items: center; gap: 0.35rem; margin-bottom: 0.25rem; }
  .pf-nav {
    flex-shrink: 0;
    width: 30px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    line-height: 1;
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.4rem;
    background: none;
    color: var(--sl-color-gray-3);
    cursor: pointer;
    transition: all 0.15s;
    user-select: none;
  }
  .pf-nav:hover:not(.pf-nav-off) { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); color: var(--sl-color-white); }
  .pf-nav-off { opacity: 0.2; cursor: default; }

  /* THE CARD: fixed 220px height */
  .pf-card {
    flex: 1;
    min-width: 0;
    height: 220px;
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    background: var(--sl-color-black);
    box-shadow: var(--sl-shadow-sm);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: border-color 0.2s, background-color 0.2s;
  }
  .pf-card:hover { border-color: var(--sl-color-gray-2); background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); }

  /* Face: fills space, content centered */
  .pf-face {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 0.75rem 1rem;
    min-height: 0;
    overflow-y: auto;
  }

  /* Bottom: hint & rate-row stacked via grid, rate-row always reserves space */
  .pf-card-bottom {
    flex-shrink: 0;
    padding: 0 0.75rem 0.6rem;
    display: grid;
    place-items: center;
  }
  .pf-card-bottom > * { grid-area: 1 / 1; }
  .pf-rate-row { visibility: hidden; display: flex; gap: 0.35rem; z-index: 1; }

  /* Card elements */
  .pf-badge {
    display: inline-block;
    font-size: var(--sl-text-2xs);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.1rem 0.35rem;
    border-radius: 0.2rem;
    background: var(--sl-color-gray-5);
    color: var(--sl-color-gray-2);
    margin-bottom: 0.25rem;
  }
  .pf-badge-ans { background: var(--sl-color-accent-low); color: var(--sl-color-accent-high); }
  .pf-word { font-size: 1.4rem; font-weight: 700; color: var(--sl-color-white); margin-bottom: 0.1rem; line-height: var(--sl-line-height-headings); }
  .pf-ipa { font-size: var(--sl-text-xs); color: var(--sl-color-gray-3); margin-bottom: 0.25rem; }
  .pf-divider { width: 40px; height: 1px; background: var(--sl-color-gray-5); margin: 0.4rem 0; }
  .pf-answer { font-size: 1.15rem; font-weight: 600; color: var(--sl-color-text-accent); margin-bottom: 0.1rem; }

  /* Audio */
  .pf-audio {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.25rem;
    border: none;
    border-radius: 50%;
    background: none;
    color: var(--sl-color-gray-3);
    cursor: pointer;
    transition: color 0.15s, background-color 0.15s, transform 0.15s;
  }
  .pf-audio:hover { color: var(--sl-color-text-accent); background-color: var(--sl-color-accent-low); transform: scale(1.1); }
  .pf-audio-big { transform: scale(1.7); margin: 0.5rem 0; }
  .pf-audio-big:hover { transform: scale(1.85); }

  /* Listen mode */
  .pf-listen-q { font-size: 1.75rem; font-weight: 700; color: var(--sl-color-gray-3); margin-top: 0.25rem; }

  /* Hint */
  .pf-hint { font-size: var(--sl-text-xs); color: var(--sl-color-gray-3); font-style: italic; z-index: 0; }
  .pf-keys { text-align: center; font-size: var(--sl-text-2xs); color: var(--sl-color-gray-3); margin-top: 0.15rem; }

  /* Rating buttons */
  .pf-rate {
    padding: 0.25rem 0.75rem;
    border-radius: 999rem;
    font-size: var(--sl-text-xs);
    font-weight: 600;
    cursor: pointer;
    border: 2px solid var(--sl-color-gray-5);
    background: none;
    color: var(--sl-color-white);
    transition: all 0.15s;
  }
  .pf-rate-again { border-color: #f87171; color: #f87171; }
  .pf-rate-again:hover { background: #f87171; color: var(--sl-color-black); }
  .pf-rate-hard { border-color: #fbbf24; color: #fbbf24; }
  .pf-rate-hard:hover { background: #fbbf24; color: var(--sl-color-black); }
  .pf-rate-easy { border-color: #4ade80; color: #4ade80; }
  .pf-rate-easy:hover { background: #4ade80; color: var(--sl-color-black); }

  /* ========== Summary ========== */
  .pf-sum { text-align: center; }
  .pf-sum-top { margin-bottom: 0.5rem; }
  .pf-sum-title { font-size: var(--sl-text-base); font-weight: 700; color: var(--sl-color-white); }
  .pf-sum-sub { font-size: var(--sl-text-xs); color: var(--sl-color-gray-3); margin-left: 0.5rem; }

  .pf-sum-badges { display: flex; gap: 0.4rem; justify-content: center; margin-bottom: 0.6rem; }
  .pf-sb { font-size: var(--sl-text-2xs); font-weight: 700; padding: 0.15rem 0.5rem; border-radius: 999rem; }
  .pf-sb-easy { color: #4ade80; background: rgba(74, 222, 128, 0.12); }
  .pf-sb-hard { color: #fbbf24; background: rgba(251, 191, 36, 0.12); }
  .pf-sb-again { color: #f87171; background: rgba(248, 113, 113, 0.12); }

  .pf-sum-actions { display: flex; gap: 0.4rem; justify-content: center; flex-wrap: wrap; margin-bottom: 0.75rem; }
  .pf-btn-pri {
    padding: 0.35rem 1rem;
    border-radius: 999rem;
    font-size: var(--sl-text-xs);
    font-weight: 700;
    cursor: pointer;
    border: 1px solid var(--sl-color-text-accent);
    background: var(--sl-color-text-accent);
    color: var(--sl-color-black);
    transition: opacity 0.15s;
  }
  .pf-btn-pri:hover { opacity: 0.88; }
  .pf-btn-sec {
    padding: 0.35rem 1rem;
    border-radius: 999rem;
    font-size: var(--sl-text-xs);
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--sl-color-gray-5);
    background: none;
    color: var(--sl-color-white);
    transition: all 0.15s;
  }
  .pf-btn-sec:hover { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); }

  /* Summary word table */
  .pf-sum-table-wrap {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.4rem;
    text-align: left;
    margin-bottom: 0.5rem;
  }
  .pf-sum-table { width: 100%; border-collapse: collapse; font-size: var(--sl-text-2xs); }
  .pf-sum-table thead { position: sticky; top: 0; background: var(--sl-color-black); z-index: 1; }
  .pf-sum-table th {
    padding: 0.25rem 0.4rem;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--sl-color-gray-5);
    color: var(--sl-color-gray-2);
    font-size: var(--sl-text-2xs);
  }
  .pf-sum-table td { padding: 0.2rem 0.4rem; border-bottom: 1px solid var(--sl-color-gray-6); }
  .pf-sr-nl { color: var(--sl-color-white); font-weight: 600; }
  .pf-sr-en { color: var(--sl-color-gray-2); }
  .pf-sr-rat { font-weight: 700; font-size: var(--sl-text-2xs); text-align: center; width: 40px; }
  .pf-sr-easy .pf-sr-rat { color: #4ade80; }
  .pf-sr-hard .pf-sr-rat { color: #fbbf24; }
  .pf-sr-again .pf-sr-rat { color: #f87171; }
  .pf-sr-again { background-color: rgba(248, 113, 113, 0.08); }
  .pf-sr-skip .pf-sr-rat { color: var(--sl-color-gray-3); }

  /* Link */
  .pf-link { text-align: center; margin-top: 0.5rem; }
  .pf-link a { font-size: var(--sl-text-xs); color: var(--sl-color-text-accent); text-decoration: none; font-weight: 600; }
  .pf-link a:hover { text-decoration: underline; }

  /* Focus styles */
  .pf-rate:focus-visible, .pf-tbtn:focus-visible, .pf-nav:focus-visible,
  .pf-dir:focus-visible, .pf-start:focus-visible, .pf-audio:focus-visible,
  .pf-btn-pri:focus-visible, .pf-btn-sec:focus-visible {
    outline: 2px solid var(--sl-color-text-accent);
    outline-offset: 2px;
  }

  /* ========== Mobile ========== */
  @media (max-width: 480px) {
    .pf-word { font-size: 1.15rem; }
    .pf-answer { font-size: 1rem; }
    .pf-card { height: 200px; }
    .pf-nav { width: 26px; height: 50px; }
    .pf-keys { display: none; }
  }
  @media (pointer: coarse) {
    .pf-nav { min-width: 44px; min-height: 44px; }
    .pf-dir { min-height: 40px; padding: 0.4rem 0.7rem; }
    .pf-start { min-height: 48px; }
    .pf-audio { min-width: 44px; min-height: 44px; padding: 8px; }
    .pf-rate { min-height: 44px; padding: 0.4rem 0.75rem; }
    .pf-tbtn { min-height: 36px; }
    .pf-btn-pri, .pf-btn-sec { min-height: 44px; }
  }
</style>
