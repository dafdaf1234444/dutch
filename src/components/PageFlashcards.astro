---
// PageFlashcards – Scans the current page's tables for Dutch vocabulary
// and renders a mini flashcard practice section. Two-way cards,
// single-button flow, keyboard shortcuts, reshuffle.
---

<page-flashcards id="page-flashcards"></page-flashcards>

<script>
import { speakDutch } from "../scripts/dutch-speech";

const DUTCH_HEADERS = new Set([
  "dutch", "dutch word", "dutch expression", "dutch phrase",
  "example", "example sentence", "example sentences",
  "dialogue", "infinitive", "word", "diminutive",
  "singular", "plural", "original", "conjugation",
  "stem", "correct stem", "statement", "question",
  "tag", "example question", "example answer",
  "sentence", "base verb", "prefix",
  "normal", "inverted (question)",
  "name", "spelling", "ik", "jij", "hij/zij/het", "wij",
  "raw stem", "position 1", "verb", "subject", "rest",
  "example words", "proof (vowel follows)",
]);
const ENGLISH_HEADERS = new Set(["english", "meaning", "translation", "english meaning"]);
const IPA_HEADERS = new Set(["ipa", "pronunciation"]);

interface Card { dutch: string; english: string; ipa: string; }

function cleanText(cell: Element): string {
  const clone = cell.cloneNode(true) as Element;
  clone.querySelectorAll("em").forEach(em => em.remove());
  clone.querySelectorAll(".dutch-audio-btn").forEach(btn => btn.remove());
  let text = clone.textContent?.trim() ?? "";
  // Strip all parenthetical content containing letters (English translations)
  text = text.replace(/\s*\([^)]*[a-zA-Z][^)]*\)\s*/g, " ");
  // Strip IPA in square brackets [hɔnt] and slashes /maːn/
  text = text.replace(/\[[^\]]*\]/g, "");
  text = text.replace(/\/[^/]+\//g, "");
  // Strip arrow symbols (used in devoicing tables)
  text = text.replace(/→/g, "");
  return text.replace(/\s+/g, " ").trim();
}

function extractCards(): Card[] {
  const cards: Card[] = [];
  const seen = new Set<string>();
  for (const table of document.querySelectorAll("table")) {
    const headers = table.querySelectorAll("thead th");
    let dCol = -1, eCol = -1, iCol = -1;
    headers.forEach((th, i) => {
      const t = th.textContent?.trim().toLowerCase() ?? "";
      if (dCol === -1 && DUTCH_HEADERS.has(t)) dCol = i;
      if (eCol === -1 && ENGLISH_HEADERS.has(t)) eCol = i;
      if (iCol === -1 && IPA_HEADERS.has(t)) iCol = i;
    });
    if (dCol === -1) continue;
    for (const row of table.querySelectorAll("tbody tr")) {
      const cells = row.querySelectorAll("td");
      const dutch = cleanText(cells[dCol]);
      if (!dutch || dutch.length < 2) continue;
      const key = dutch.toLowerCase();
      if (seen.has(key)) continue;
      seen.add(key);
      cards.push({
        dutch,
        english: eCol >= 0 ? cleanText(cells[eCol]) : "",
        ipa: iCol >= 0 ? cells[iCol]?.textContent?.trim() ?? "" : "",
      });
    }
  }
  return cards;
}

type Dir = "nl-en" | "en-nl" | "mixed" | "listen";

class PageFlashcards extends HTMLElement {
  cards: Card[] = [];
  order: number[] = [];
  showDutchFirst: boolean[] = [];
  current = 0;
  flipped = false;
  direction: Dir = "mixed";
  private _kh: ((e: KeyboardEvent) => void) | null = null;

  static SVG = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;

  connectedCallback() {
    const init = () => {
      this.cards = extractCards();
      if (this.cards.length < 2) { this.style.display = "none"; return; }
      this.renderButton();
    };
    if ("requestIdleCallback" in window) requestIdleCallback(init);
    else requestAnimationFrame(() => setTimeout(init, 0));
  }

  shuffle(arr: number[]): number[] {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  esc(s: string): string {
    return s.replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  }

  bindKeys() {
    this.unbindKeys();
    this._kh = (e: KeyboardEvent) => {
      if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) return;
      if (e.key === " " || e.key === "Enter") { e.preventDefault(); this.advance(); }
      else if (e.key === "ArrowRight") { e.preventDefault(); if (this.flipped) { this.current++; this.flipped = false; this.renderCard(); } }
      else if (e.key === "ArrowLeft") { e.preventDefault(); if (this.current > 0) { this.current--; this.flipped = false; this.renderCard(); } }
    };
    document.addEventListener("keydown", this._kh);
  }

  unbindKeys() {
    if (this._kh) { document.removeEventListener("keydown", this._kh); this._kh = null; }
  }

  advance() {
    if (!this.flipped) {
      this.flipped = true;
      if (!this.showDutchFirst[this.current]) {
        speakDutch(this.cards[this.order[this.current]].dutch);
      }
      this.renderCard();
    } else {
      this.current++;
      this.flipped = false;
      this.renderCard();
    }
  }

  buildOrder() {
    this.order = this.shuffle([...Array(this.cards.length).keys()]);
    this.showDutchFirst = this.order.map(() => {
      if (this.direction === "nl-en" || this.direction === "listen") return true;
      if (this.direction === "en-nl") return false;
      return Math.random() < 0.5;
    });
  }

  renderButton() {
    this.unbindKeys();
    this.innerHTML = `
      <div class="pf-section pf-frame">
        <div class="pf-frame-header">
          <span class="pf-frame-icon">&#9881;</span>
          <span class="pf-frame-title">Practice Flashcards</span>
          <span class="pf-frame-count">${this.cards.length} cards on this page</span>
        </div>
        <div class="pf-start-row">
          <div class="pf-dir-row">
            <button class="pf-dir ${this.direction === "nl-en" ? "pf-dir-on" : ""}" data-d="nl-en" type="button">NL→EN</button>
            <button class="pf-dir ${this.direction === "en-nl" ? "pf-dir-on" : ""}" data-d="en-nl" type="button">EN→NL</button>
            <button class="pf-dir ${this.direction === "mixed" ? "pf-dir-on" : ""}" data-d="mixed" type="button">Mixed</button>
            <button class="pf-dir ${this.direction === "listen" ? "pf-dir-on" : ""}" data-d="listen" type="button">Listen</button>
          </div>
          <button class="pf-start-btn" id="pf-start" type="button">
            Start Practice
          </button>
          <div class="pf-fc-link"><a href="/dutch/flashcards/">Practice all topics &rarr;</a></div>
        </div>
      </div>`;
    this.querySelectorAll<HTMLButtonElement>(".pf-dir").forEach(b => {
      b.addEventListener("click", () => { this.direction = b.dataset.d as Dir; this.renderButton(); });
    });
    this.querySelector("#pf-start")!.addEventListener("click", () => this.start());
  }

  start() {
    this.buildOrder();
    this.current = 0;
    this.flipped = false;
    this.bindKeys();
    this.renderCard();
  }

  reshuffle() {
    this.buildOrder();
    this.current = 0;
    this.flipped = false;
    this.renderCard();
  }

  renderCard() {
    const total = this.order.length;

    if (this.current >= total) {
      this.unbindKeys();
      this.innerHTML = `
        <div class="pf-section pf-frame">
          <div class="pf-frame-header">
            <span class="pf-frame-icon">&#10003;</span>
            <span class="pf-frame-title">Practice Complete</span>
          </div>
          <div class="pf-done">
            <p>You reviewed all ${total} cards.</p>
            <div class="pf-actions">
              <button class="pf-btn pf-btn-secondary" id="pf-close" type="button">Close</button>
              <button class="pf-btn pf-btn-primary" id="pf-restart" type="button">Restart</button>
            </div>
          </div>
        </div>`;
      this.querySelector("#pf-close")!.addEventListener("click", () => this.renderButton());
      this.querySelector("#pf-restart")!.addEventListener("click", () => this.start());
      return;
    }

    const card = this.cards[this.order[this.current]];
    const dutch = this.showDutchFirst[this.current];
    const isListen = this.direction === "listen";
    const num = this.current + 1;
    const pct = Math.round((this.current / total) * 100);

    let cardContent: string;

    if (isListen && !this.flipped) {
      // Listen mode front: only audio button + "?"
      cardContent = `
        <div class="pf-badge">LISTEN</div>
        <button class="dutch-audio-btn pf-audio pf-listen-btn" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${PageFlashcards.SVG}</button>
        <div class="pf-listen-hint">?</div>`;
    } else if (isListen && this.flipped) {
      // Listen mode back: show Dutch + English + IPA
      cardContent = `
        <div class="pf-badge">NL</div>
        <div class="pf-word">${this.esc(card.dutch)}</div>
        ${card.ipa ? `<div class="pf-ipa">${this.esc(card.ipa)}</div>` : ""}
        <button class="dutch-audio-btn pf-audio" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${PageFlashcards.SVG}</button>
        <div class="pf-reveal-divider"></div>
        <div class="pf-badge pf-badge-answer">EN</div>
        <div class="pf-answer">${this.esc(card.english)}</div>`;
    } else {
      // Normal modes
      const frontWord = dutch ? card.dutch : card.english;
      const frontSub = dutch && card.ipa ? `<div class="pf-ipa">${this.esc(card.ipa)}</div>` : "";
      const frontAudio = dutch ? `<button class="dutch-audio-btn pf-audio" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${PageFlashcards.SVG}</button>` : "";
      const fLabel = dutch ? "NL" : "EN";

      const backWord = dutch ? card.english : card.dutch;
      const backSub = !dutch && card.ipa ? `<div class="pf-ipa">${this.esc(card.ipa)}</div>` : "";
      const backAudio = !dutch ? `<button class="dutch-audio-btn pf-audio" data-text="${this.esc(card.dutch)}" type="button" aria-label="Listen">${PageFlashcards.SVG}</button>` : "";
      const bLabel = dutch ? "EN" : "NL";

      cardContent = `
        <div class="pf-badge">${fLabel}</div>
        <div class="pf-word">${this.esc(frontWord)}</div>
        ${frontSub}
        ${frontAudio}
        ${this.flipped ? `
          <div class="pf-reveal-divider"></div>
          <div class="pf-badge pf-badge-answer">${bLabel}</div>
          <div class="pf-answer">${this.esc(backWord)}</div>
          ${backSub}
          ${backAudio}
        ` : ""}`;
    }

    this.innerHTML = `
      <div class="pf-section pf-frame">
        <div class="pf-header">
          <button class="pf-btn pf-btn-small pf-btn-secondary" id="pf-close" type="button">Close</button>
          <span class="pf-counter">${num} / ${total}</span>
          <button class="pf-btn pf-btn-small pf-btn-secondary" id="pf-reshuffle" type="button">Shuffle</button>
        </div>
        <div class="pf-progress"><div class="pf-progress-fill" style="width:${pct}%"></div></div>

        <div class="pf-card-row">
          <button class="pf-nav ${this.current === 0 ? "pf-nav-disabled" : ""}" id="pf-prev" type="button" aria-label="Previous">&#8249;</button>
          <div class="pf-card" id="pf-card">
            ${cardContent}
          </div>
          <button class="pf-nav" id="pf-next" type="button" aria-label="Next">&#8250;</button>
        </div>

        <div class="pf-key-hint">&larr; Prev &nbsp; Space / Enter &nbsp; Next &rarr;</div>
        <div class="pf-fc-link"><a href="/dutch/flashcards/">Practice all topics &rarr;</a></div>
      </div>`;

    this.querySelector("#pf-next")!.addEventListener("click", () => this.advance());
    this.querySelector("#pf-prev")!.addEventListener("click", () => {
      if (this.current > 0) { this.current--; this.flipped = false; this.renderCard(); }
    });
    this.querySelector("#pf-card")!.addEventListener("click", (e) => {
      if ((e.target as Element).closest(".dutch-audio-btn")) return;
      this.advance();
    });
    this.querySelector("#pf-close")!.addEventListener("click", () => { this.unbindKeys(); this.renderButton(); });
    this.querySelector("#pf-reshuffle")!.addEventListener("click", () => this.reshuffle());

    // Auto-play in Listen mode
    if (isListen && !this.flipped) {
      setTimeout(() => speakDutch(card.dutch), 150);
    }
  }
}

customElements.define("page-flashcards", PageFlashcards);
</script>

<style>
  .pf-section { max-width: 540px; margin: 2rem auto 0; }

  /* Frame container for clear visual separation */
  .pf-frame {
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.75rem;
    padding: 1.25rem;
    background: var(--sl-color-bg-nav);
    box-shadow: var(--sl-shadow-sm);
    margin-top: 2.5rem;
  }
  .pf-frame-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--sl-color-gray-5);
  }
  .pf-frame-icon {
    font-size: 1.1rem;
    line-height: 1;
  }
  .pf-frame-title {
    font-size: var(--sl-text-base);
    font-weight: 700;
    color: var(--sl-color-white);
  }
  .pf-frame-count {
    font-size: var(--sl-text-xs);
    color: var(--sl-color-gray-3);
    margin-left: auto;
  }

  /* start area */
  .pf-start-row { display: flex; flex-direction: column; gap: 0.6rem; }
  .pf-dir-row { display: flex; gap: 0.35rem; justify-content: center; }
  .pf-dir {
    padding: 0.3rem 0.7rem; border-radius: 999rem; font-size: var(--sl-text-xs); font-weight: 600;
    cursor: pointer; border: 1px solid var(--sl-color-gray-5); background: none;
    color: var(--sl-color-white); transition: all 0.15s;
  }
  .pf-dir:hover { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); }
  .pf-dir.pf-dir-on { background: var(--sl-color-text-accent); color: var(--sl-color-black); border-color: var(--sl-color-text-accent); }

  .pf-start-btn {
    display: block; width: 100%; padding: 0.75rem 1rem;
    border: 1px solid var(--sl-color-text-accent); border-radius: 999rem;
    background: none; color: var(--sl-color-text-accent);
    font-size: var(--sl-text-sm); font-weight: 600; cursor: pointer;
    transition: background-color 0.15s, color 0.15s;
  }
  .pf-start-btn:hover { background: var(--sl-color-text-accent); color: var(--sl-color-black); }

  /* toolbar */
  .pf-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
  .pf-counter { font-size: var(--sl-text-2xs); color: var(--sl-color-gray-3); font-variant-numeric: tabular-nums; }
  .pf-progress { width: 100%; height: 4px; border-radius: 2px; background: var(--sl-color-gray-5); margin-bottom: 1rem; overflow: hidden; }
  .pf-progress-fill { height: 100%; border-radius: 2px; background: var(--sl-color-accent); transition: width 0.3s ease; }

  /* card row with nav arrows */
  .pf-card-row { display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.75rem; }
  .pf-nav {
    flex-shrink: 0; width: 34px; height: 70px; display: flex; align-items: center; justify-content: center;
    font-size: 1.4rem; line-height: 1; border: 1px solid var(--sl-color-gray-5); border-radius: 0.5rem;
    background: none; color: var(--sl-color-gray-3); cursor: pointer; transition: all 0.15s; user-select: none;
  }
  .pf-nav:hover:not(.pf-nav-disabled) { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); color: var(--sl-color-white); }
  .pf-nav-disabled { opacity: 0.2; cursor: default; }

  /* card */
  .pf-card {
    flex: 1; min-width: 0;
    border: 1px solid var(--sl-color-gray-5); border-radius: 0.5rem;
    padding: 1.75rem 1.25rem; min-height: 160px; cursor: pointer;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    text-align: center; background: var(--sl-color-black);
    box-shadow: var(--sl-shadow-sm); transition: border-color 0.2s, background-color 0.2s;
  }
  .pf-card:hover { border-color: var(--sl-color-gray-2); background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); }
  .pf-badge {
    display: inline-block; font-size: var(--sl-text-2xs); font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.05em; padding: 0.1rem 0.4rem; border-radius: 0.25rem;
    background: var(--sl-color-gray-5); color: var(--sl-color-gray-2); margin-bottom: 0.4rem;
  }
  .pf-badge-answer { background: var(--sl-color-accent-low); color: var(--sl-color-accent-high); }
  .pf-word { font-size: 1.5rem; font-weight: 700; color: var(--sl-color-white); margin-bottom: 0.2rem; line-height: var(--sl-line-height-headings); }
  .pf-ipa { font-size: var(--sl-text-xs); color: var(--sl-color-gray-3); margin-bottom: 0.4rem; }
  .pf-audio {
    display: inline-flex; align-items: center; justify-content: center;
    padding: 0.3rem; border: none; border-radius: 50%;
    background: none; color: var(--sl-color-gray-3); cursor: pointer;
    transition: color 0.15s, background-color 0.15s, transform 0.15s;
  }
  .pf-audio:hover { color: var(--sl-color-text-accent); background-color: var(--sl-color-accent-low); transform: scale(1.1); }
  .pf-reveal-divider { width: 50px; height: 1px; background: var(--sl-color-gray-5); margin: 0.7rem 0; }
  .pf-answer { font-size: 1.2rem; font-weight: 600; color: var(--sl-color-text-accent); margin-bottom: 0.15rem; }

  /* key hint */
  .pf-key-hint { text-align: center; font-size: var(--sl-text-2xs); color: var(--sl-color-gray-3); margin-top: 0.4rem; }

  /* done */
  .pf-done { text-align: center; }
  .pf-done p { color: var(--sl-color-white); margin-bottom: 1rem; }
  .pf-actions { display: flex; gap: 0.5rem; justify-content: center; }
  .pf-btn {
    padding: 0.45rem 1.2rem; border-radius: 999rem; font-size: var(--sl-text-xs); font-weight: 600;
    cursor: pointer; border: 1px solid var(--sl-color-gray-5); background: none;
    color: var(--sl-color-white); transition: background-color 0.15s, opacity 0.15s;
  }
  .pf-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .pf-btn-primary { background: var(--sl-color-text-accent); color: var(--sl-color-black); border-color: var(--sl-color-text-accent); }
  .pf-btn-primary:hover:not(:disabled) { opacity: 0.88; }
  .pf-btn-secondary:hover:not(:disabled) { background-color: var(--sl-color-gray-7, var(--sl-color-gray-6)); border-color: var(--sl-color-gray-2); }
  .pf-btn-small { padding: 0.25rem 0.7rem; font-size: var(--sl-text-2xs); }

  /* listen mode */
  .pf-listen-btn { transform: scale(1.8); margin: 0.75rem 0; }
  .pf-listen-hint { font-size: 2rem; font-weight: 700; color: var(--sl-color-gray-3); margin-top: 0.5rem; }

  /* flashcard link */
  .pf-fc-link { text-align: center; margin-top: 0.5rem; }
  .pf-fc-link a {
    font-size: var(--sl-text-xs); color: var(--sl-color-text-accent); text-decoration: none; font-weight: 600;
  }
  .pf-fc-link a:hover { text-decoration: underline; }

  /* Mobile responsiveness */
  @media (max-width: 480px) {
    .pf-word { font-size: 1.25rem; }
    .pf-answer { font-size: 1.05rem; }
    .pf-card { padding: 1.25rem 0.75rem; min-height: 140px; }
    .pf-nav { width: 30px; height: 60px; }
    .pf-key-hint { display: none; }
  }
  @media (pointer: coarse) {
    .pf-nav { min-width: 44px; min-height: 44px; }
    .pf-btn { min-height: 44px; }
    .pf-dir { min-height: 40px; padding: 0.5rem 0.8rem; }
    .pf-start-btn { min-height: 48px; }
    .pf-audio { min-width: 44px; min-height: 44px; padding: 8px; }
  }
</style>
